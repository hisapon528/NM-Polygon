<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ­£ N/M è§’å½¢ï¼ˆè¤‡æ•°ãƒ»åŒæ™‚ã‚¢ãƒ‹ãƒ¡ãƒ»è¨­å®šï¼‰</title>
  <style>
    :root{
      --bg:#0b0f17; --panel:#111827; --fg:#e5e7eb; --muted:#9ca3af;
      --border: rgba(255,255,255,.10);
      --border2: rgba(255,255,255,.14);
      --accent:#60a5fa;
    }
    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
      background: radial-gradient(1200px 700px at 30% 20%, #111827, #05070b);
      color:var(--fg);
      overflow: hidden; /* â‘£ ç”»é¢å…¨ä½“ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ãªã„ */
    }

    .wrap{
      display:grid;
      grid-template-columns: 420px 1fr;
      height:100vh;
      width:100vw;
    }

    /* â‘£ å·¦ãƒ‘ãƒãƒ«ã ã‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    .panel{
      height:100vh;
      overflow-y:auto;
      padding:16px;
      background: rgba(17,24,39,.86);
      border-right: 1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(8px);
    }

    h1{ font-size:18px; margin:0 0 10px; }
    .desc{ font-size:12px; color:var(--muted); line-height:1.55; margin-bottom:12px; }

    .controlsTop{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0 14px;
      position: sticky; top: 0; z-index: 5;
      padding: 10px 0;
      background: linear-gradient(to bottom, rgba(17,24,39,.96), rgba(17,24,39,.70));
      backdrop-filter: blur(6px);
    }

    button{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.06);
      color:var(--fg);
      cursor:pointer;
      user-select:none;
    }
    button:hover{ background: rgba(255,255,255,.10); }
    .btnPrimary{ border-color: rgba(96,165,250,.45); }
    .btnToggle { border-color: rgba(52,211,153,.35); }
    .btnDanger{ border-color: rgba(248,113,113,.35); }

    .rows{
      display:flex; flex-direction:column; gap:10px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:14px;
      background: rgba(0,0,0,.18);
      margin-bottom: 12px;
    }

    .rowCard{
      display:grid;
      grid-template-columns: 1fr 1fr auto auto auto;
      gap:8px;
      align-items:center;
      padding:10px;
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      background: rgba(255,255,255,.04);
    }
    .rowCard .label{
      font-size:11px; color:var(--muted); margin-bottom:4px;
    }
    .rowCard .field{ display:flex; flex-direction:column; }
    input[type="number"]{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color:var(--fg);
      outline:none;
    }
    .iconBtn{
      width:40px; height:40px;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius:12px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      font-size:16px;
    }
    .iconBtn:hover{ background: rgba(255,255,255,.10); }
    .swatch{
      width:14px; height:14px; border-radius:6px;
      border:1px solid rgba(255,255,255,.25);
      display:inline-block;
      vertical-align:middle;
      margin-left:6px;
    }
    .rowMeta{
      grid-column: 1 / -1;
      font-size:11px;
      color: var(--muted);
      margin-top:4px;
      line-height:1.5;
    }

    .globalBox{
      margin-top:12px;
      padding:12px;
      border:1px solid var(--border);
      border-radius:14px;
      background: rgba(0,0,0,.18);
      font-size:12px;
      line-height:1.65;
      color: var(--muted);
    }
    .globalBox b{ color:#fff; }

    /* â‘£ å³å´ã¯å¸¸ã«ä¸­å¤®å›ºå®šï¼ˆå·¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®å½±éŸ¿ã‚’å—ã‘ãªã„ï¼‰ */
    .canvasWrap{
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    /* æ­£æ–¹å½¢ã‚’ç¶­æŒ */
    .square{
      width: min(920px, calc(100vw - 470px));
      aspect-ratio: 1 / 1;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    canvas{ width:100%; height:100%; display:block; }

    /* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index: 1000;
    }
    .modal{
      width:min(520px, 96vw);
      background: rgba(17,24,39,.96);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    .modalHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px;
    }
    .modalTitle{ font-size:14px; font-weight:700; }
    .closeBtn{
      width:38px; height:38px; border-radius:12px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.06);
      color:var(--fg); cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size:16px;
    }
    .closeBtn:hover{ background: rgba(255,255,255,.10); }
    .modalBody{
      display:flex; flex-direction:column; gap:10px;
      padding:10px;
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      background: rgba(0,0,0,.18);
      font-size:12px;
    }
    .modalRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:8px 8px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .modalRow .left{ color: var(--fg); }
    .modalRow .right{ display:flex; gap:8px; align-items:center; }
    input[type="color"]{
      width:44px; height:32px;
      border:none; background: transparent; padding:0;
      cursor:pointer;
    }
    .tiny{
      font-size:11px;
      color: var(--muted);
      line-height: 1.5;
      margin-top: 8px;
    }
    .footerNote{
      margin-top:10px;
      font-size:11px;
      color:var(--muted);
      line-height:1.55;
      padding-bottom: 16px;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="panel">
    <h1>æ­£ N/M è§’å½¢ï¼ˆè¤‡æ•°ãƒ»åŒæ™‚ã‚¢ãƒ‹ãƒ¡ï¼‰</h1>
    <div class="desc">
      å††å‘¨ä¸Šã® <b>N</b> ç­‰åˆ†ç‚¹ã‹ã‚‰ã€ã‚¹ãƒ†ãƒƒãƒ—å¹… <b>M</b> ã§é ‚ç‚¹ã‚’è¾¿ã‚Šã€å§‹ç‚¹ <b>0</b> ã«æˆ»ã£ãŸç¬é–“ã«çµ‚äº†ã—ã¾ã™ï¼ˆå§‹ç‚¹ãšã‚‰ã—ã¯ã—ã¾ã›ã‚“ï¼‰ã€‚<br/>
      ã€Œï¼‹ã€ã§è¤‡æ•°ã® {N/M} ã‚’åŒä¸€ã‚­ãƒ£ãƒ³ãƒã‚¹ã«è‰²åˆ†ã‘ã§é‡ã­æãã§ãã¾ã™ã€‚
    </div>

    <div class="controlsTop">
      <button id="addRow" class="btnPrimary">ï¼‹ è¿½åŠ </button>
      <button id="toggleAll" class="btnToggle">â–¶ å…¨ã‚¢ãƒ‹ãƒ¡å†ç”Ÿ</button>
      <button id="saveAll">ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜ï¼ˆPNGï¼‰</button>
    </div>

    <div class="rows" id="rows"></div>
    <div class="globalBox" id="globalInfo"></div>

    <div class="footerNote">
      âœ… å·¦ãƒ‘ãƒãƒ«ã®ã¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆè¡Œã‚’ã„ãã‚‰å¢—ã‚„ã—ã¦ã‚‚OKï¼‰<br/>
      âœ… å³ã®æç”»ã¯å¸¸ã«ä¸­å¤®ï¼†æ­£æ–¹å½¢ï¼ˆå¤–æ¥å††ãŒæ­ªã¿ã¾ã›ã‚“ï¼‰<br/>
      â€» M ã¯å†…éƒ¨ã§ <b>M mod N</b> ã«æ­£è¦åŒ–ï¼ˆ0ã¯ä¸å¯ï¼‰ã—ã¾ã™ã€‚<br/>
      â€» å…¨ã‚¢ãƒ‹ãƒ¡å†ç”Ÿã§ã¯ã€å„è¡Œã®è¾ºæ•°ã«å¿œã˜ã¦é€Ÿåº¦ã‚’è‡ªå‹•èª¿æ•´ã—ã€åŒæ™‚ã«æãçµ‚ã‚ã‚Šã¾ã™ã€‚
    </div>
  </div>

  <div class="canvasWrap">
    <div class="square">
      <canvas id="cv"></canvas>
    </div>
  </div>
</div>

<!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modalOverlay" id="modalOverlay">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHeader">
      <div class="modalTitle" id="modalTitle">è¨­å®š</div>
      <button class="closeBtn" id="modalClose" title="é–‰ã˜ã‚‹">âœ•</button>
    </div>
    <div class="modalBody">
      <div class="modalRow">
        <div class="left">ã“ã®å›³å½¢ã‚’è¡¨ç¤º</div>
        <div class="right"><input type="checkbox" id="optVisible"></div>
      </div>

      <div class="modalRow">
        <div class="left">é ‚ç‚¹ã‚’è¡¨ç¤º</div>
        <div class="right"><input type="checkbox" id="optShowPoints"></div>
      </div>

      <div class="modalRow">
        <div class="left">é ‚ç‚¹ç•ªå·ã‚’è¡¨ç¤º</div>
        <div class="right"><input type="checkbox" id="optShowLabels"></div>
      </div>

      <div class="modalRow">
        <div class="left">ç·šã®è‰²</div>
        <div class="right"><input type="color" id="optLineColor"></div>
      </div>

      <div class="modalRow">
        <div class="left">é ‚ç‚¹ã®è‰²</div>
        <div class="right"><input type="color" id="optPointColor"></div>
      </div>

      <div class="modalRow">
        <div class="left">ç·šã¨é ‚ç‚¹ã‚’åŒè‰²ã«ã™ã‚‹</div>
        <div class="right"><input type="checkbox" id="optLinkColors"></div>
      </div>

      <div class="tiny">
        ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€Œç·šè‰²ï¼é ‚ç‚¹è‰²ã€ã§ã™ã€‚<br/>
        è§£é™¤ã™ã‚‹ã¨ã€ç·šè‰²ã¨é ‚ç‚¹è‰²ã‚’åˆ¥ã€…ã«ã§ãã¾ã™ã€‚
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');

  const rowsEl = document.getElementById('rows');
  const globalInfoEl = document.getElementById('globalInfo');

  const btnAdd = document.getElementById('addRow');
  const btnToggleAll = document.getElementById('toggleAll');
  const btnSave = document.getElementById('saveAll');

  // Modal
  const modalOverlay = document.getElementById('modalOverlay');
  const modalTitle = document.getElementById('modalTitle');
  const modalClose = document.getElementById('modalClose');
  const optVisible = document.getElementById('optVisible');
  const optShowPoints = document.getElementById('optShowPoints');
  const optShowLabels = document.getElementById('optShowLabels');
  const optLineColor = document.getElementById('optLineColor');
  const optPointColor = document.getElementById('optPointColor');
  const optLinkColors = document.getElementById('optLinkColors');

  const TAU = Math.PI * 2;

  // ======= â‘¡â‘¢ å…¨ã‚¢ãƒ‹ãƒ¡ã®ç·æ™‚é–“ï¼ˆç§’ï¼‰
  // ã€Œã‚†ã£ãã‚Šä½œå›³ãŒåˆ†ã‹ã‚‹ã€ãã‚‰ã„ã«å›ºå®šï¼ˆå¿…è¦ãªã‚‰å¾Œã§å¤‰æ›´å¯ï¼‰
  const TOTAL_ANIM_TIME = 8.0;

  // è¡Œã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰²
  const palette = [
    "#60a5fa", "#f472b6", "#34d399", "#f59e0b", "#a78bfa",
    "#22d3ee", "#fb7185", "#84cc16", "#e879f9", "#f87171",
  ];

  function gcd(a,b){
    a = Math.abs(a); b = Math.abs(b);
    while(b !== 0){ const t = a % b; a = b; b = t; }
    return a;
  }
  function normalizeStep(N, M){
    let s = M % N;
    if (s < 0) s += N;
    return s; // 0..N-1
  }
  function pointsOnCircle(N, cx, cy, r){
    const pts = [];
    for(let k=0;k<N;k++){
      const ang = -Math.PI/2 + TAU*(k/N);
      pts.push({ x: cx + r*Math.cos(ang), y: cy + r*Math.sin(ang) });
    }
    return pts;
  }
  function buildCycle(N, step){
    // 0 ã«æˆ»ã£ãŸæ™‚ç‚¹ã§åœæ­¢ï¼ˆæœ€å¾Œã®0ã‚’å«ã‚€ï¼‰
    const seq = [0];
    if (N <= 0 || step === 0) return seq;
    let cur = 0;
    const seen = new Set([0]); // safety
    while(true){
      cur = (cur + step) % N;
      seq.push(cur);
      if(cur === 0) break;
      if (seen.has(cur)) break;
      seen.add(cur);
      if (seq.length > N + 2) break;
    }
    return seq;
  }

  // ====== ã‚­ãƒ£ãƒ³ãƒã‚¹ã®é«˜è§£åƒåº¦å¯¾å¿œ ======
  function resizeCanvasToDisplaySize(){
    const dpr = window.devicePixelRatio || 1;
    const rect = cv.getBoundingClientRect();
    const w = Math.max(1, Math.floor(rect.width * dpr));
    const h = Math.max(1, Math.floor(rect.height * dpr));
    if (cv.width !== w || cv.height !== h){
      cv.width = w;
      cv.height = h;
    }
    ctx.setTransform(1,0,0,1,0,0);
  }

  // ====== è¡Œãƒ‡ãƒ¼ã‚¿ ======
  let nextId = 1;
  const rows = [];
  let rafId = null;
  let lastT = null;

  // â‘¢ å…¨ä½“ãƒˆã‚°ãƒ«çŠ¶æ…‹
  let globalPlaying = false;

  function newRowDefaults(){
    const idx = rows.length;
    const base = palette[idx % palette.length];
    return {
      id: nextId++,
      N: 7,
      M: 2,
      visible: true,
      showPoints: true,
      showLabels: false,
      lineColor: base,
      pointColor: base,
      linkColors: true,

      // ã‚¢ãƒ‹ãƒ¡é–¢é€£
      animPlaying: false,
      animEdgeCount: 0,
      animSpeedEdgesPerSec: 0,
    };
  }

  function rowTitle(r){
    return `#${r.id}  N=${r.N}, M=${r.M}`;
  }

  function getEdgesCount(r){
    const N = r.N, M = r.M;
    if (!Number.isInteger(N) || !Number.isInteger(M) || N < 3 || M < 1) return 0;
    const step = normalizeStep(N, M);
    if (step === 0) return 0;
    const cycle = buildCycle(N, step);
    return Math.max(0, cycle.length - 1);
  }

  // â‘¡â‘¢ å…¨ã‚¢ãƒ‹ãƒ¡é–‹å§‹æ™‚ã«ã€ŒåŒæ™‚çµ‚äº†ã€ã«ãªã‚‹ã‚ˆã†é€Ÿåº¦ã‚’è¨­å®š
  function prepareSpeedsForAll(){
    for (const r of rows){
      const edges = getEdgesCount(r);
      r.animEdgeCount = 0;
      // edges=0 ã®å ´åˆã¯é€Ÿåº¦ä¸è¦
      r.animSpeedEdgesPerSec = edges > 0 ? (edges / TOTAL_ANIM_TIME) : 0;
    }
  }

  function createRowUI(r){
    const card = document.createElement('div');
    card.className = 'rowCard';
    card.dataset.rowId = String(r.id);

    const fieldN = document.createElement('div');
    fieldN.className = 'field';
    fieldN.innerHTML = `<div class="label">N</div>`;
    const inN = document.createElement('input');
    inN.type = 'number'; inN.min = '1'; inN.step = '1';
    inN.value = String(r.N);
    fieldN.appendChild(inN);

    const fieldM = document.createElement('div');
    fieldM.className = 'field';
    fieldM.innerHTML = `<div class="label">M</div>`;
    const inM = document.createElement('input');
    inM.type = 'number'; inM.min = '1'; inM.step = '1';
    inM.value = String(r.M);
    fieldM.appendChild(inM);

    // è¡Œã”ã¨ã®å†ç”Ÿåœæ­¢ï¼ˆå€‹åˆ¥ï¼‰
    const btnAnim = document.createElement('button');
    btnAnim.className = 'iconBtn';
    btnAnim.title = 'ã“ã®è¡Œã®ã‚¢ãƒ‹ãƒ¡ å†ç”Ÿ/åœæ­¢';
    btnAnim.textContent = 'â–¶';

    const btnGear = document.createElement('button');
    btnGear.className = 'iconBtn';
    btnGear.title = 'è¨­å®š';
    btnGear.textContent = 'âš™';

    const btnDel = document.createElement('button');
    btnDel.className = 'iconBtn';
    btnDel.title = 'å‰Šé™¤';
    btnDel.textContent = 'ğŸ—‘';

    const meta = document.createElement('div');
    meta.className = 'rowMeta';

    function updateMeta(){
      const N = r.N, M = r.M;
      if (!Number.isInteger(N) || !Number.isInteger(M) || N < 1 || M < 1){
        meta.textContent = `å…¥åŠ›ã‚¨ãƒ©ãƒ¼ï¼ˆN,Mã¯è‡ªç„¶æ•°ï¼‰`;
        return;
      }
      if (N < 3){
        meta.textContent = `æ³¨æ„: N=${N} ã¯å¤šè§’å½¢ã«ãªã‚Šã¾ã›ã‚“ï¼ˆNâ‰¥3æ¨å¥¨ï¼‰`;
        return;
      }
      const step = normalizeStep(N, M);
      const d = gcd(N, step);
      const L = (step === 0) ? 0 : (N / d);
      const sw = `<span class="swatch" style="background:${r.lineColor}"></span>`;
      meta.innerHTML = `step=M mod N = ${step}, gcd(N,step)=${d}, é–‰è·¯é•·L=${L} ${sw}`;
    }

    function applyN(){
      const v = Math.floor(Number(inN.value));
      r.N = Number.isFinite(v) ? v : r.N;
      if (r.N < 1) r.N = 1;
      inN.value = String(r.N);

      // å€¤å¤‰æ›´ã§ã‚¢ãƒ‹ãƒ¡ã¯ãƒªã‚»ãƒƒãƒˆï¼ˆå€‹åˆ¥ã®å†ç”Ÿã‚’ç¶­æŒã™ã‚‹ã¨æ··ä¹±ã—ã‚„ã™ã„ã®ã§åœæ­¢ï¼‰
      r.animPlaying = false;
      r.animEdgeCount = 0;
      card._setAnimIcon();
      // å…¨ä½“å†ç”Ÿä¸­ã ã£ãŸã‚‰å…¨ä½“ã¯åœæ­¢çŠ¶æ…‹ã«æˆ»ã™
      if (globalPlaying){
        globalPlaying = false;
        btnToggleAll.textContent = "â–¶ å…¨ã‚¢ãƒ‹ãƒ¡å†ç”Ÿ";
      }
      scheduleDraw();
    }
    function applyM(){
      const v = Math.floor(Number(inM.value));
      r.M = Number.isFinite(v) ? v : r.M;
      if (r.M < 1) r.M = 1;
      inM.value = String(r.M);

      r.animPlaying = false;
      r.animEdgeCount = 0;
      card._setAnimIcon();
      if (globalPlaying){
        globalPlaying = false;
        btnToggleAll.textContent = "â–¶ å…¨ã‚¢ãƒ‹ãƒ¡å†ç”Ÿ";
      }
      scheduleDraw();
    }

    inN.addEventListener('input', applyN);
    inM.addEventListener('input', applyM);
    inN.addEventListener('change', applyN);
    inM.addEventListener('change', applyM);

    btnAnim.addEventListener('click', () => {
      // å€‹åˆ¥å†ç”Ÿã¯ã€Œã“ã®è¡Œã ã‘ TOTAL_ANIM_TIME ã§æãçµ‚ã‚ã‚‹ã€é€Ÿåº¦ã«ã™ã‚‹
      const edges = getEdgesCount(r);
      r.animEdgeCount = (r.animEdgeCount > 0 && r.animEdgeCount < edges) ? r.animEdgeCount : 0;
      r.animSpeedEdgesPerSec = edges > 0 ? (edges / TOTAL_ANIM_TIME) : 0;

      r.animPlaying = !r.animPlaying;
      card._setAnimIcon();

      // å…¨ä½“å†ç”Ÿã¨ã®äºŒé‡ç®¡ç†ã‚’é¿ã‘ã‚‹ï¼šå€‹åˆ¥æ“ä½œã‚’ã—ãŸã‚‰å…¨ä½“ã¯OFFæ‰±ã„
      if (globalPlaying){
        globalPlaying = false;
        btnToggleAll.textContent = "â–¶ å…¨ã‚¢ãƒ‹ãƒ¡å†ç”Ÿ";
      }

      scheduleDraw();
    });

    btnGear.addEventListener('click', () => openSettings(r, card));

    btnDel.addEventListener('click', () => {
      const i = rows.findIndex(x => x.id === r.id);
      if (i >= 0) rows.splice(i,1);
      card.remove();
      // è¡Œå‰Šé™¤ã§å…¨ä½“å†ç”Ÿã¯æ­¢ã‚ã‚‹ï¼ˆé€Ÿåº¦å†è¨ˆç®—ãŒå¿…è¦ãªã®ã§ï¼‰
      if (globalPlaying){
        globalPlaying = false;
        btnToggleAll.textContent = "â–¶ å…¨ã‚¢ãƒ‹ãƒ¡å†ç”Ÿ";
      }
      scheduleDraw();
    });

    card._updateMeta = updateMeta;
    card._setAnimIcon = () => { btnAnim.textContent = r.animPlaying ? 'â¸' : 'â–¶'; };

    card.appendChild(fieldN);
    card.appendChild(fieldM);
    card.appendChild(btnAnim);
    card.appendChild(btnGear);
    card.appendChild(btnDel);
    card.appendChild(meta);

    updateMeta();
    card._setAnimIcon();
    return card;
  }

  // ====== è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« ======
  let modalRow = null;
  let modalRowCard = null;

  function openSettings(r, card){
    modalRow = r;
    modalRowCard = card;
    modalTitle.textContent = `è¨­å®š ${rowTitle(r)}`;

    optVisible.checked = r.visible;
    optShowPoints.checked = r.showPoints;
    optShowLabels.checked = r.showLabels;
    optLineColor.value = r.lineColor;
    optPointColor.value = r.pointColor;
    optLinkColors.checked = r.linkColors;

    optPointColor.disabled = r.linkColors;

    modalOverlay.style.display = 'flex';
  }
  function closeSettings(){
    modalOverlay.style.display = 'none';
    modalRow = null;
    modalRowCard = null;
  }

  function syncModalToRow(){
    if (!modalRow) return;
    const r = modalRow;

    r.visible = optVisible.checked;
    r.showPoints = optShowPoints.checked;
    r.showLabels = optShowLabels.checked;

    r.linkColors = optLinkColors.checked;

    r.lineColor = optLineColor.value;

    if (r.linkColors){
      r.pointColor = r.lineColor;
      optPointColor.value = r.pointColor;
      optPointColor.disabled = true;
    } else {
      optPointColor.disabled = false;
      r.pointColor = optPointColor.value;
    }

    if (modalRowCard && modalRowCard._updateMeta) modalRowCard._updateMeta();

    // è¨­å®šå¤‰æ›´ã¯æç”»ã«å³åæ˜ 
    scheduleDraw();
  }

  modalClose.addEventListener('click', closeSettings);
  modalOverlay.addEventListener('click', (e) => {
    if (e.target === modalOverlay) closeSettings();
  });
  [optVisible,optShowPoints,optShowLabels,optLineColor,optPointColor,optLinkColors].forEach(el => {
    el.addEventListener('input', syncModalToRow);
    el.addEventListener('change', syncModalToRow);
  });

  // ====== æç”» ======
  function clearCanvas(){
    ctx.clearRect(0,0,cv.width,cv.height);
  }

  function drawCircle(cx, cy, r){
    ctx.save();
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, TAU);
    ctx.strokeStyle = 'rgba(255,255,255,.18)';
    ctx.lineWidth = Math.max(1, cv.width * 0.002);
    ctx.stroke();
    ctx.restore();
  }

  function drawRow(r, cx, cy, radius){
    if (!r.visible) return;

    const N = r.N, M = r.M;
    if (!Number.isInteger(N) || !Number.isInteger(M) || N < 1 || M < 1) return;

    const pts = pointsOnCircle(N, cx, cy, radius);

    // é ‚ç‚¹
    if (r.showPoints && N >= 1){
      ctx.save();
      const dot = Math.max(2, cv.width * 0.004);
      for(let i=0;i<N;i++){
        ctx.beginPath();
        ctx.arc(pts[i].x, pts[i].y, dot, 0, TAU);
        ctx.fillStyle = r.pointColor;
        ctx.globalAlpha = 0.80;
        ctx.fill();
        ctx.globalAlpha = 1.0;

        if (r.showLabels){
          ctx.fillStyle = 'rgba(255,255,255,.85)';
          ctx.font = `${Math.max(10, cv.width*0.018)}px system-ui, sans-serif`;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          const vx = pts[i].x - cx, vy = pts[i].y - cy;
          const len = Math.hypot(vx,vy) || 1;
          const tx = pts[i].x + (vx/len)*Math.max(12, cv.width*0.02);
          const ty = pts[i].y + (vy/len)*Math.max(12, cv.width*0.02);
          ctx.fillText(String(i), tx, ty);
        }
      }
      ctx.restore();
    }

    if (N < 3) return;

    const step = normalizeStep(N, M);
    if (step === 0) return;

    const cycle = buildCycle(N, step); // [0,...,0]
    const totalEdges = cycle.length - 1;
    if (totalEdges <= 0) return;

    // é€²æ—ï¼šåœæ­¢ä¸­ã¯ã€Œå®Œå…¨è¡¨ç¤ºã€ã«æˆ»ã™ä»•æ§˜ã«ã™ã‚‹ï¼ˆæ¯”è¼ƒç”¨é€”ã§è¦‹ã‚„ã™ã„ï¼‰
    // å€‹åˆ¥åœæ­¢ã§é€”ä¸­ã§æ­¢ã‚ãŸã„å ´åˆã¯ã€ä¸‹ã® else ã‚’ r.animEdgeCount ã«ã™ã‚‹
    let edgesToDraw = totalEdges;
    if (r.animPlaying){
      edgesToDraw = Math.min(totalEdges, Math.floor(r.animEdgeCount));
    }

    if (edgesToDraw > 0){
      ctx.save();
      ctx.beginPath();
      ctx.moveTo(pts[cycle[0]].x, pts[cycle[0]].y);
      for(let i=1;i<=edgesToDraw;i++){
        ctx.lineTo(pts[cycle[i]].x, pts[cycle[i]].y);
      }
      ctx.strokeStyle = r.lineColor;
      ctx.globalAlpha = 0.95;
      ctx.lineWidth = Math.max(1.5, cv.width * 0.0045);
      ctx.lineJoin = 'round';
      ctx.lineCap = 'round';
      ctx.stroke();
      ctx.globalAlpha = 1.0;
      ctx.restore();
    }
  }

  function anyAnimationPlaying(){
    return rows.some(r => r.animPlaying);
  }

  function tick(t){
    if (lastT == null) lastT = t;
    const dt = (t - lastT) / 1000;
    lastT = t;

    for(const r of rows){
      if (!r.animPlaying) continue;

      const edges = getEdgesCount(r);
      if (edges <= 0){
        r.animPlaying = false;
        continue;
      }

      // â‘¡â‘¢ é€Ÿåº¦ã¯è¡Œã”ã¨ã«è¨­å®šæ¸ˆã¿ï¼ˆå…¨ã‚¢ãƒ‹ãƒ¡æ™‚ã¯åŒæ™‚çµ‚äº†ã™ã‚‹ã‚ˆã†ã«èª¿æ•´ï¼‰
      r.animEdgeCount += (r.animSpeedEdgesPerSec * dt);

      if (r.animEdgeCount >= edges){
        r.animEdgeCount = edges;
        r.animPlaying = false;

        // UIã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°
        const card = rowsEl.querySelector(`.rowCard[data-row-id="${r.id}"]`);
        if (card && card._setAnimIcon) card._setAnimIcon();
      }
    }

    drawAll();
    updateGlobalInfo();

    if (anyAnimationPlaying()){
      rafId = requestAnimationFrame(tick);
    } else {
      rafId = null;
      lastT = null;

      // å…¨ä½“å†ç”Ÿä¸­ã ã£ãŸå ´åˆã€å®Œäº†ã—ãŸã‚‰ãƒˆã‚°ãƒ«ã‚’ã€Œå†ç”Ÿã€ã«æˆ»ã™
      if (globalPlaying){
        globalPlaying = false;
        btnToggleAll.textContent = "â–¶ å…¨ã‚¢ãƒ‹ãƒ¡å†ç”Ÿ";
      }
    }
  }

  function scheduleDraw(){
    drawAll();
    updateGlobalInfo();

    if (anyAnimationPlaying() && !rafId){
      rafId = requestAnimationFrame(tick);
    }
    if (!anyAnimationPlaying() && rafId){
      cancelAnimationFrame(rafId);
      rafId = null;
      lastT = null;
    }
  }

  function drawAll(){
    resizeCanvasToDisplaySize();
    clearCanvas();

    const cx = cv.width/2, cy = cv.height/2;
    const radius = Math.min(cv.width, cv.height) * 0.82 * 0.5;

    // å…±é€šå¤–æ¥å††
    drawCircle(cx, cy, radius);

    for(const r of rows){
      drawRow(r, cx, cy, radius);
    }
  }

  function updateGlobalInfo(){
    const total = rows.length;
    const visible = rows.filter(r => r.visible).length;
    const playing = rows.filter(r => r.animPlaying).length;

    globalInfoEl.innerHTML = `
      <b>è¡Œæ•°</b>: ${total}ï¼ˆè¡¨ç¤º: ${visible}ï¼‰<br/>
      <b>ã‚¢ãƒ‹ãƒ¡ä¸­</b>: ${playing}<br/>
      <b>å…¨ä½“ã‚¢ãƒ‹ãƒ¡æ™‚é–“</b>: ç´„ ${TOTAL_ANIM_TIME.toFixed(1)} ç§’ï¼ˆè¾ºæ•°ã«å¿œã˜ã¦é€Ÿåº¦ã‚’è‡ªå‹•èª¿æ•´ï¼‰<br/>
      <b>ä¿å­˜</b>: ã€Œã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜ï¼ˆPNGï¼‰ã€ã§ã‚­ãƒ£ãƒ³ãƒã‚¹å…¨ä½“ã‚’ä¿å­˜
    `;
  }

  // ====== æ“ä½œ ======
  function addRow(initial){
    const r = Object.assign(newRowDefaults(), initial || {});
    const idx = rows.length;
    const base = palette[idx % palette.length];
    if (!initial || !initial.lineColor) r.lineColor = base;
    if (!initial || !initial.pointColor) r.pointColor = base;
    if (r.linkColors) r.pointColor = r.lineColor;

    rows.push(r);
    const ui = createRowUI(r);
    rowsEl.appendChild(ui);

    // è¿½åŠ ã§å…¨ä½“å†ç”Ÿã¯æ­¢ã‚ã‚‹ï¼ˆé€Ÿåº¦å†è¨ˆç®—ãŒå¿…è¦ãªã®ã§ï¼‰
    if (globalPlaying){
      globalPlaying = false;
      btnToggleAll.textContent = "â–¶ å…¨ã‚¢ãƒ‹ãƒ¡å†ç”Ÿ";
    }

    scheduleDraw();
  }

  btnAdd.addEventListener('click', () => addRow());

  // â‘¢ å…¨ã‚¢ãƒ‹ãƒ¡å†ç”Ÿ/åœæ­¢ãƒˆã‚°ãƒ«ï¼ˆåŒæ™‚é–‹å§‹ãƒ»åŒæ™‚çµ‚äº†ï¼‰
  btnToggleAll.addEventListener('click', () => {
    globalPlaying = !globalPlaying;

    if (globalPlaying){
      // å…¨å“¡ã‚’ã€ŒåŒæ™‚ã«æãçµ‚ãˆã‚‹ã€é€Ÿåº¦ã§ã‚»ãƒƒãƒˆ
      prepareSpeedsForAll();
      for (const r of rows){
        const edges = getEdgesCount(r);
        r.animPlaying = edges > 0;  // è¾ºãŒã‚ã‚‹è¡Œã ã‘å‹•ã‹ã™
        // å€‹åˆ¥ãƒœã‚¿ãƒ³è¡¨ç¤ºæ›´æ–°
        const card = rowsEl.querySelector(`.rowCard[data-row-id="${r.id}"]`);
        if (card && card._setAnimIcon) card._setAnimIcon();
      }
      btnToggleAll.textContent = "â¸ å…¨ã‚¢ãƒ‹ãƒ¡åœæ­¢";
      scheduleDraw();
    } else {
      // å…¨åœæ­¢ï¼ˆé€”ä¸­ã§æ­¢ã‚ãŸã„å ´åˆã¯ animEdgeCount ã‚’ä¿æŒï¼‰
      for (const r of rows){
        r.animPlaying = false;
        const card = rowsEl.querySelector(`.rowCard[data-row-id="${r.id}"]`);
        if (card && card._setAnimIcon) card._setAnimIcon();
      }
      btnToggleAll.textContent = "â–¶ å…¨ã‚¢ãƒ‹ãƒ¡å†ç”Ÿ";
      scheduleDraw();
    }
  });

  // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜ï¼ˆPNGï¼‰
  btnSave.addEventListener('click', () => {
    const url = cv.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = url;
    a.download = `NM-polygons.png`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  });

  window.addEventListener('resize', () => scheduleDraw());

  // ====== åˆæœŸè¡Œ ======
  addRow({ N: 7, M: 2 });

})();
</script>
</body>
</html>
