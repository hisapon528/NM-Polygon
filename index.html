<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ­£ N/M è§’å½¢</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">

  <style>
    :root{
      /* Theme vars (default: dark) */
      --bg:#0b0f17;
      --bgImg: radial-gradient(1200px 700px at 30% 20%, rgba(17,24,39,1), rgba(5,7,11,1));
      --fg:#e5e7eb;
      --muted:#9ca3af;

      --panel: rgba(17,24,39,.86);
      --panelSolid:#111827;

      --border: rgba(255,255,255,.10);
      --border2: rgba(255,255,255,.14);

      /* Buttons */
      --btnBg: rgba(255,255,255,.06);
      --btnBgHover: rgba(255,255,255,.10);
      --btnBorder: rgba(255,255,255,.14);

      /* controls/boxes */
      --controlsBg: linear-gradient(to bottom, var(--panelSolid), rgba(17,24,39,.60));
      --boxBg: rgba(0,0,0,.18);
      --cardBg: rgba(255,255,255,.04);

      /* Canvas */
      --canvasBg: rgba(0,0,0,0); /* actual fill done in JS */
      --circle: rgba(255,255,255,.18);

      /* HUD box */
      --hudBg: rgba(0,0,0,.55);
      --hudFg: rgba(255,255,255,.92);
      --hudBorder: rgba(255,255,255,.18);

      /* Modal vars (dark default) */
      --overlayBg: rgba(0,0,0,.55);
      --modalBg: rgba(17,24,39,.96);
      --modalBorder: rgba(255,255,255,.10);
      --modalBodyBg: rgba(0,0,0,.18);
      --modalRowBg: rgba(255,255,255,.03);
      --modalRowBorder: rgba(255,255,255,.08);
      --inputBg: rgba(0,0,0,.25);
      --shadow: 0 20px 60px rgba(0,0,0,.45);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
      background-color: var(--bg);
      background-image: var(--bgImg);
      color:var(--fg);
      overflow:hidden;
    }

    .wrap{
      display:grid;
      grid-template-columns: 440px 1fr;
      height:100vh;
      width:100vw;
    }

    /* Left panel scroll only */
    .panel{
      height:100vh;
      overflow-y:auto;
      padding:16px;
      background: var(--panel);
      border-right: 1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(8px);
    }

    h1{ font-size:18px; margin:0 0 10px; }
    .desc{
      font-size:12px; color:var(--muted); line-height:1.55; margin-bottom:12px;
    }

    .controlsTop{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0 14px;
      position: sticky; top: 0; z-index: 5;
      padding: 10px 0;
      background: var(--controlsBg);
      border-bottom: 1px solid rgba(255,255,255,.06);
      box-shadow:none;
      backdrop-filter:none;
    }

    button{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--btnBorder);
      background: var(--btnBg);
      color:var(--fg);
      cursor:pointer;
      user-select:none;
    }
    button:hover{ background: var(--btnBgHover); }

    .btnPrimary{ border-color: rgba(96,165,250,.55); }
    .btnToggle { border-color: rgba(52,211,153,.45); }
    .btnWarn   { border-color: rgba(251,191,36,.55); }

    .rows{
      display:flex; flex-direction:column; gap:10px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:14px;
      background: var(--boxBg);
      margin-bottom: 12px;
    }

    .rowCard{
      display:grid;
      grid-template-columns: 1fr 1fr auto auto auto;
      gap:8px;
      align-items:center;
      padding:10px;
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      background: var(--cardBg);
      box-shadow:none;
    }
    .rowCard .label{
      font-size:11px; color:var(--muted); margin-bottom:4px;
    }
    .rowCard .field{ display:flex; flex-direction:column; }

    input[type="number"]{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background: var(--inputBg);
      color:var(--fg);
      outline:none;
    }

    .iconBtn{
      width:40px; height:40px;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius:12px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      font-size:16px;
      color: var(--fg);
      box-shadow:none;
    }
    .iconBtn:hover{ background: rgba(255,255,255,.10); }

    .swatch{
      width:14px; height:14px; border-radius:6px;
      border:1px solid rgba(255,255,255,.25);
      display:inline-block;
      vertical-align:middle;
      margin-left:6px;
    }
    .rowMeta{
      grid-column: 1 / -1;
      font-size:11px;
      color: var(--muted);
      margin-top:4px;
      line-height:1.55;
    }

    .globalBox{
      margin-top:12px;
      padding:12px;
      border:1px solid var(--border);
      border-radius:14px;
      background: var(--boxBg);
      font-size:12px;
      line-height:1.65;
      color: var(--muted);
      box-shadow:none;
    }
    .globalBox b{ color:var(--fg); }

    /* Right side fixed center */
    .canvasWrap{
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .square{
      width: min(940px, calc(100vw - 490px));
      aspect-ratio: 1 / 1;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: transparent;
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    canvas{ width:100%; height:100%; display:block; cursor: grab; }
    canvas.dragging{ cursor: grabbing; }

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0;
      background: var(--overlayBg);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index: 1000;
    }
    .modal{
      width:min(580px, 96vw);
      background: var(--modalBg);
      border:1px solid var(--modalBorder);
      border-radius:18px;
      padding:14px;
      box-shadow: var(--shadow);
    }
    .modalHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px;
    }
    .modalTitle{ font-size:14px; font-weight:700; }
    .closeBtn{
      width:38px; height:38px; border-radius:12px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.06);
      color:var(--fg); cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size:16px;
    }
    .closeBtn:hover{ background: rgba(255,255,255,.10); }

    .modalBody{
      display:flex; flex-direction:column; gap:10px;
      padding:10px;
      border:1px solid var(--modalRowBorder);
      border-radius:14px;
      background: var(--modalBodyBg);
      font-size:12px;
    }
    .modalRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:8px 8px;
      border-radius:12px;
      border:1px solid var(--modalRowBorder);
      background: var(--modalRowBg);
    }
    .modalRow .left{ color: var(--fg); }
    .modalRow .right{ display:flex; gap:8px; align-items:center; }

    input[type="color"]{
      width:44px; height:32px;
      border:none; background: transparent; padding:0;
      cursor:pointer;
    }
    .miniInput{
      width: 150px;
      padding:8px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background: var(--inputBg);
      color: var(--fg);
      outline:none;
      font-size: 12px;
    }

    .tiny{
      font-size:11px;
      color: var(--muted);
      line-height: 1.5;
      margin-top: 8px;
    }
    .footerNote{
      margin-top:10px;
      font-size:11px;
      color:var(--muted);
      line-height:1.55;
      padding-bottom: 16px;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="panel">
    <h1>æ­£ N/M è§’å½¢</h1>
    <div class="desc">
      å††å‘¨ä¸Šã‚’ <b>N</b> ç­‰åˆ†ã—ãŸç‚¹ã‚’ã€<b>M</b> å€‹ã¨ã°ã—ã§è¾¿ã‚Šã¾ã™ã€‚<br/>
      ä½œå›³ã¯ <b>å§‹ç‚¹ï¼ˆstartï¼‰</b> ã‚’åŸºæº–ã«ã—ã€<b>å§‹ç‚¹ã«æˆ»ã£ãŸç¬é–“ã«çµ‚äº†</b>ã—ã¾ã™ã€‚<br/>
      å›³å½¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€æç”»å·¦ä¸Šã«ãã®å›³å½¢ã® <b>Nã¨M</b>ã®å€¤ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
    </div>

    <div class="controlsTop">
      <button id="addRow" class="btnPrimary">ï¼‹ è¿½åŠ </button>
      <button id="resetAll" class="btnWarn">ãƒªã‚»ãƒƒãƒˆ</button>
      <button id="openGlobal" class="btnWarn">è¨­å®š</button>
      <button id="toggleAll" class="btnToggle">â–¶ å…¨ã‚¢ãƒ‹ãƒ¡å†ç”Ÿ</button>
      <button id="saveAll">ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜ï¼ˆPNGï¼‰</button>
    </div>

    <div class="rows" id="rows"></div>
    <div class="globalBox" id="globalInfo"></div>

    <div class="footerNote">
      â€» M ã¯å†…éƒ¨ã§ <b>M mod N</b>ã€å§‹ç‚¹ã¯ <b>start mod N</b> ã«æ­£è¦åŒ–ã€‚<br/>
    </div>
  </div>

  <div class="canvasWrap">
    <div class="square">
      <canvas id="cv"></canvas>
    </div>
  </div>
</div>

<!-- è¡Œè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modalOverlay" id="rowModalOverlay">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHeader">
      <div class="modalTitle" id="rowModalTitle">è¨­å®š</div>
      <button class="closeBtn" id="rowModalClose" title="é–‰ã˜ã‚‹">âœ•</button>
    </div>

    <div class="modalBody">
      <div class="modalRow">
        <div class="left">ã“ã®å›³å½¢ã‚’è¡¨ç¤º</div>
        <div class="right"><input type="checkbox" id="optVisible"></div>
      </div>

      <div class="modalRow">
        <div class="left">é ‚ç‚¹ã‚’è¡¨ç¤º</div>
        <div class="right"><input type="checkbox" id="optShowPoints"></div>
      </div>

      <div class="modalRow">
        <div class="left">é ‚ç‚¹ç•ªå·ã‚’è¡¨ç¤º</div>
        <div class="right"><input type="checkbox" id="optShowLabels"></div>
      </div>

      <div class="modalRow">
        <div class="left">é ‚ç‚¹ç•ªå·ã‚µã‚¤ã‚ºï¼ˆpxï¼‰</div>
        <div class="right">
          <input class="miniInput" type="number" id="optLabelSize" min="8" step="1" />
        </div>
      </div>

      <div class="modalRow">
        <div class="left">ç·šã®è‰²</div>
        <div class="right"><input type="color" id="optLineColor"></div>
      </div>

      <div class="modalRow">
        <div class="left">é ‚ç‚¹ã®è‰²</div>
        <div class="right"><input type="color" id="optPointColor"></div>
      </div>

      <div class="modalRow">
        <div class="left">ã‚¢ãƒ‹ãƒ¡æ™‚é–“ï¼ˆç§’ï¼‰</div>
        <div class="right">
          <input class="miniInput" type="number" id="optAnimTime" min="0.2" step="0.1" />
        </div>
      </div>

      <div class="modalRow">
        <div class="left">å§‹ç‚¹ï¼ˆstartï¼‰</div>
        <div class="right">
          <input class="miniInput" type="number" id="optStart" step="1" />
        </div>
      </div>

      <div class="tiny">
        â€»å§‹ç‚¹ã¯å†…éƒ¨ã§ <b>start mod N</b> ã«æ­£è¦åŒ–ã™ã‚‹ã€‚<br/>
        â€»é ‚ç‚¹ç•ªå·ã¯èƒŒæ™¯ã«å¿œã˜ã¦è¦‹ã‚„ã™ã„è‰²ï¼ˆè‡ªå‹•ï¼‰ã§æç”»ã—ã¾ã™ã€‚<br/>
      </div>
    </div>
  </div>
</div>

<!-- å…¨ä½“è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modalOverlay" id="globalModalOverlay">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHeader">
      <div class="modalTitle">å…¨ä½“è¨­å®š</div>
      <button class="closeBtn" id="globalModalClose" title="é–‰ã˜ã‚‹">âœ•</button>
    </div>

    <div class="modalBody">
      <div class="modalRow">
        <div class="left">èƒŒæ™¯</div>
        <div class="right">
          <select id="optTheme" class="miniInput" style="width:170px">
            <option value="dark">ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</option>
            <option value="light">ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰</option>
          </select>
        </div>
      </div>

      <div class="modalRow">
        <div class="left">å¤–æ¥å††ã®è‰²</div>
        <div class="right">
          <input type="color" id="optCircleColor">
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // =========================================================
  // 0) DOMå‚ç…§
  // =========================================================
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');

  const rowsEl = document.getElementById('rows');
  const globalInfoEl = document.getElementById('globalInfo');

  const btnAdd = document.getElementById('addRow');
  const btnReset = document.getElementById('resetAll');
  const btnToggleAll = document.getElementById('toggleAll');
  const btnSave = document.getElementById('saveAll');
  const btnOpenGlobal = document.getElementById('openGlobal');

  // Row modal
  const rowModalOverlay = document.getElementById('rowModalOverlay');
  const rowModalTitle = document.getElementById('rowModalTitle');
  const rowModalClose = document.getElementById('rowModalClose');
  const optVisible = document.getElementById('optVisible');
  const optShowPoints = document.getElementById('optShowPoints');
  const optShowLabels = document.getElementById('optShowLabels');
  const optLabelSize = document.getElementById('optLabelSize');
  const optLineColor = document.getElementById('optLineColor');
  const optPointColor = document.getElementById('optPointColor');
  const optAnimTime = document.getElementById('optAnimTime');
  const optStart = document.getElementById('optStart');

  // Global modal
  const globalModalOverlay = document.getElementById('globalModalOverlay');
  const globalModalClose = document.getElementById('globalModalClose');
  const optTheme = document.getElementById('optTheme');
  const optCircleColor = document.getElementById('optCircleColor');

  // =========================================================
  // 1) å®šæ•°
  // =========================================================
  const TAU = Math.PI * 2;

  // CSSä¸Šã®å›³å½¢ã‚’å°‘ã—ä¸‹ã’ã‚‹ãŸã‚ã®å€¤
  const DEFAULT_CENTER_Y_OFFSET_CSS = 60;

  // ã‚¢ãƒ‹ãƒ¡ï¼Œå§‹ç‚¹ï¼Œæ–‡å­—ã®å¤§ãã•ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
  const DEFAULT_ANIM_TIME = 8.0;
  const DEFAULT_START = 0;
  const DEFAULT_LABEL_SIZE = 22;

  // å…¥åŠ›æ¬„ã®è‰²ã‚’å¾ªç’°ã•ã›ã‚‹ãƒ‘ãƒ¬ãƒƒãƒˆ
  const palette = [
    "#60a5fa", "#f472b6", "#34d399", "#f59e0b", "#a78bfa",
    "#22d3ee", "#fb7185", "#84cc16", "#e879f9", "#f87171",
  ];

  // =========================================================
  // 2) å®šç¾©ï¼“.ï¼‘ã‹ã‚‰å°ã‹ã‚Œã‚‹æ•°å¼ã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹
  // =========================================================
  class MathBase {
    /**
     * ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰ã®äº’é™¤æ³•ã§æœ€å¤§å…¬ç´„æ•° gcd(a,b) ã‚’è¿”ã™
     * - a,b ãŒè² ã§ã‚‚ abs ã‚’å–ã£ã¦å¯¾å¿œã™ã‚‹ã€‚
     * - æˆ»ã‚Šå€¤ã¯å¸¸ã« 0 ä»¥ä¸Š
     */
    static gcd(a, b) {
      a = Math.abs(a);
      b = Math.abs(b);
      while (b !== 0) {
        const t = a % b;
        a = b;
        b = t;
      }
      return a;
    }
  }

  /**
   * ModularMathï¼šåˆåŒï¼ˆmodï¼‰è¨ˆç®—ã‚’æ‰±ã†
   * - MathBase ã‚’ç¶™æ‰¿ã—ã€gcd ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
     * å¸¸ã« 0..m-1 ã®ç¯„å›²ã«å…¥ã‚‹
     * - JS ã® % ã¯è² ãŒã‚ã‚Šå¾—ã‚‹ã®ã§è£œæ­£
  */
  class ModularMath extends MathBase {
    static mod(n, m) {
      return ((n % m) + m) % m;
    }

    /** M ã‚’ N ã§æ­£è¦åŒ–ï¼ˆstep = M mod Nï¼‰ */
    static normalizeStep(N, M) {
      return ModularMath.mod(M, N);
    }

    /** start ã‚’ N ã§æ­£è¦åŒ–ï¼ˆstartN = start mod Nï¼‰ */
    static normalizeStart(N, start) {
      return ModularMath.mod(start, N);
    }

    /**
     * step(å®šç¾©3.1ã®M)ã§å·¡å›ã—,å§‹ç‚¹ã«æˆ»ã£ãŸã¨ã“ã‚ã§çµ‚äº†ã™ã‚‹â€œå·¡å›åˆ—â€ã‚’ä½œã‚‹
     */
    static buildCycle(N, step, start) {
      const s = ModularMath.normalizeStart(N, start);
      const seq = [s];

      // N<=0 or step=0 ã®å ´åˆã¯ã€å‹•ã‹ãšã«çµ‚ã‚ã‚‹
      if (N <= 0 || step === 0) return seq;

      let cur = s;
  
      // â€œãƒ«ãƒ¼ãƒ—é˜²æ­¢â€ï¼šæœ¬æ¥ã¯ s ã«æˆ»ã‚Œã°çµ‚ã‚ã‚‹ãŒã€
      // ä¸‡ä¸€æˆ»ã‚‰ãªã„ã‚±ãƒ¼ã‚¹ã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã« seen ã‚’æŒã¤
      const seen = new Set([cur]);

      while (true) {
        cur = (cur + step) % N;
        seq.push(cur);

        // å§‹ç‚¹ã«æˆ»ã£ãŸã‚‰çµ‚äº†
        if (cur === s) break;

        // ã™ã§ã«è¨ªã‚ŒãŸç‚¹ã«å†è¨ªã—ã¦ã—ã¾ã£ãŸã‚‰çµ‚äº†
        if (seen.has(cur)) break;

        seen.add(cur);

        // é•·ã™ããŸã‚‰æ‰“ã¡åˆ‡ã‚‹
        if (seq.length > N + 2) break;
      }
      return seq;
    }
  }

  /**
   * GeometryUtilsï¼šå¹¾ä½•ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
   * - ModularMath ã‚’ç¶™æ‰¿ï¼ˆå¿…è¦ãªã‚‰ mod/gcd ã‚‚ä½¿ãˆã‚‹ï¼‰
   */
  class GeometryUtils extends ModularMath {
    /**
     * å††å‘¨ã‚’ N ç­‰åˆ†ã—ãŸç‚¹åˆ—ã‚’è¿”ã™
     * - æœ€åˆã®ç‚¹ã¯ â€œçœŸä¸Šï¼ˆ-Ï€/2ï¼‰â€ ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆå…ƒã‚³ãƒ¼ãƒ‰ä»•æ§˜ï¼‰
     * - cx,cy ã¯å††ã®ä¸­å¿ƒã€r ã¯åŠå¾„
     */
    static pointsOnCircle(N, cx, cy, r) {
      const pts = [];
      for (let k = 0; k < N; k++) {
        const ang = -Math.PI / 2 + TAU * (k / N);
        pts.push({
          x: cx + r * Math.cos(ang),
          y: cy + r * Math.sin(ang),
        });
      }
      return pts;
    }
  }

  // =========================================================
  // 3) â˜… â€œé–¢æ•° APIâ€ ã‚’ç¶­æŒã™ã‚‹ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆä½¿ç”¨ã¯ä¸€åˆ‡å¤‰ãˆãªã„ï¼‰
  // =========================================================

  function gcd(a, b) { return MathBase.gcd(a, b); }
  function mod(n, m) { return ModularMath.mod(n, m); }
  function normalizeStep(N, M) { return ModularMath.normalizeStep(N, M); }
  function normalizeStart(N, start) { return ModularMath.normalizeStart(N, start); }
  function pointsOnCircle(N, cx, cy, r) { return GeometryUtils.pointsOnCircle(N, cx, cy, r); }
  function buildCycle(N, step, start) { return ModularMath.buildCycle(N, step, start); }

  // =========================================================
  // 4) Viewï¼ˆã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³ï¼‰
  // =========================================================
  class Viewport {
    constructor() {
      this.scale = 1.0;
      this.panX = 0.0;
      this.panY = 0.0;
      this.minScale = 0.2;
      this.maxScale = 20.0;
    }

    /** ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³ã‚’åˆæœŸåŒ–ï¼ˆãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§å‘¼ã°ã‚Œã‚‹ï¼‰ */
    reset() {
      this.scale = 1.0;
      this.panX = 0.0;
      this.panY = 0.0;
    }
  }

  //  â€œviewâ€ ã¨åŒã˜å½¹å‰²
  const view = new Viewport();

  // æ—¢å­˜ã‚³ãƒ¼ãƒ‰äº’æ›ï¼šresetView()
  function resetView() { view.reset(); }

  // =========================================================
  // 5) ãƒ†ãƒ¼ãƒç®¡ç†ï¼ˆCSSå¤‰æ•°ã‚’æ›¸ãæ›ãˆã‚‹ï¼‰
  // =========================================================
  class ThemeManager {
    constructor() {
      // åŒå€¤ã®çŠ¶æ…‹ï¼štheme / circleHex
      this.state = { theme: 'dark', circleHex: '#b0b0b0' };
    }

    /**
     * #RRGGBB ã‚’ rgba(r,g,b,a) ã«ã™ã‚‹
     * - CSSå¤‰æ•° --circle ã®æŒ‡å®šã«ä½¿ã†
     */
    hexToRgba(hex, a) {
      const h = hex.replace('#', '').trim();
      const v = h.length === 3
        ? h.split('').map(ch => ch + ch).join('')
        : h.padStart(6, '0').slice(0, 6);
      const r = parseInt(v.slice(0, 2), 16);
      const g = parseInt(v.slice(2, 4), 16);
      const b = parseInt(v.slice(4, 6), 16);
      return `rgba(${r},${g},${b},${a})`;
    }

    /**
     * ç¾åœ¨ã®ãƒ†ãƒ¼ãƒè¨­å®šã‚’ CSS å¤‰æ•°ã«åæ˜ 
     */
    applyTheme(scheduleDrawFn) {
      const root = document.documentElement.style;

      if (this.state.theme === 'light') {
        root.setProperty('--bg', '#ffffff');
        root.setProperty('--bgImg', 'none');
        root.setProperty('--fg', '#111827');
        root.setProperty('--muted', '#374151');

        root.setProperty('--panel', '#ffffff');
        root.setProperty('--panelSolid', '#ffffff');
        root.setProperty('--controlsBg', '#ffffff');
        root.setProperty('--boxBg', '#ffffff');
        root.setProperty('--cardBg', '#ffffff');

        root.setProperty('--border', 'rgba(0,0,0,.12)');
        root.setProperty('--border2', 'rgba(0,0,0,.16)');

        root.setProperty('--btnBg', '#ffffff');
        root.setProperty('--btnBgHover', 'rgba(0,0,0,.06)');
        root.setProperty('--btnBorder', 'rgba(0,0,0,.30)');

        root.setProperty('--overlayBg', 'rgba(0,0,0,.25)');
        root.setProperty('--modalBg', '#ffffff');
        root.setProperty('--modalBorder', 'rgba(0,0,0,.18)');
        root.setProperty('--modalBodyBg', '#ffffff');
        root.setProperty('--modalRowBg', '#ffffff');
        root.setProperty('--modalRowBorder', 'rgba(0,0,0,.12)');
        root.setProperty('--inputBg', '#ffffff');
        root.setProperty('--shadow', '0 20px 60px rgba(0,0,0,.18)');

        root.setProperty('--canvasBg', '#ffffff');

        root.setProperty('--hudBg', 'rgba(255,255,255,.92)');
        root.setProperty('--hudFg', 'rgba(17,24,39,.98)');
        root.setProperty('--hudBorder', 'rgba(0,0,0,.20)');

        root.setProperty('--circle', this.hexToRgba(this.state.circleHex, 0.75));
      } else {
        root.setProperty('--bg', '#0b0f17');
        root.setProperty('--bgImg', 'radial-gradient(1200px 700px at 30% 20%, rgba(17,24,39,1), rgba(5,7,11,1))');
        root.setProperty('--fg', '#e5e7eb');
        root.setProperty('--muted', '#9ca3af');

        root.setProperty('--panel', 'rgba(17,24,39,.86)');
        root.setProperty('--panelSolid', '#111827');
        root.setProperty('--border', 'rgba(255,255,255,.10)');
        root.setProperty('--border2', 'rgba(255,255,255,.14)');

        root.setProperty('--btnBg', 'rgba(255,255,255,.06)');
        root.setProperty('--btnBgHover', 'rgba(255,255,255,.10)');
        root.setProperty('--btnBorder', 'rgba(255,255,255,.14)');

        root.setProperty('--controlsBg', 'linear-gradient(to bottom, var(--panelSolid), rgba(17,24,39,.60))');
        root.setProperty('--boxBg', 'rgba(0,0,0,.18)');
        root.setProperty('--cardBg', 'rgba(255,255,255,.04)');

        root.setProperty('--overlayBg', 'rgba(0,0,0,.55)');
        root.setProperty('--modalBg', 'rgba(17,24,39,.96)');
        root.setProperty('--modalBorder', 'rgba(255,255,255,.10)');
        root.setProperty('--modalBodyBg', 'rgba(0,0,0,.18)');
        root.setProperty('--modalRowBg', 'rgba(255,255,255,.03)');
        root.setProperty('--modalRowBorder', 'rgba(255,255,255,.08)');
        root.setProperty('--inputBg', 'rgba(0,0,0,.25)');
        root.setProperty('--shadow', '0 20px 60px rgba(0,0,0,.45)');

        root.setProperty('--canvasBg', 'rgba(0,0,0,0)');

        root.setProperty('--hudBg', 'rgba(0,0,0,.55)');
        root.setProperty('--hudFg', 'rgba(255,255,255,.92)');
        root.setProperty('--hudBorder', 'rgba(255,255,255,.18)');

        root.setProperty('--circle', this.hexToRgba(this.state.circleHex, 0.75));
      }

      // ãƒ†ãƒ¼ãƒã‚’å¤‰ãˆãŸã‚‰å†æç”»ï¼ˆå…ƒã‚³ãƒ¼ãƒ‰ã¨åŒã˜ï¼‰
      scheduleDrawFn();
    }
  }

  const themeManager = new ThemeManager();

  // =========================================================
  // 6) å…¥åŠ›æ¬„ï¼ˆRowï¼‰ã®ãƒ¢ãƒ‡ãƒ«
  // =========================================================
  class RowModel {
    constructor(initial) {
      Object.assign(this, initial);
    }
  }

  // =========================================================
  // 7) ã‚¢ãƒ—ãƒªæœ¬ä½“ï¼ˆè¨­å®šï¼‹æç”»ï¼‹UIï¼‹ã‚¤ãƒ™ãƒ³ãƒˆï¼‰
  // =========================================================
  class NMPolygonApp {
    constructor() {
      // ===== Canvas/è¡¨ç¤º =====
      this.centerYOffsetPx = 0;

      // ===== Row state =====
      this.nextId = 1;
      this.rows = [];
      this.rafId = null;
      this.lastT = null;
      this.globalPlaying = false;
      this.selectedRowId = null;

      // ===== Row settings modal state =====
      this.modalRow = null;
      this.modalRowCard = null;
    }

    // --------------------------
    // Canvas sizing
    // --------------------------

    /**
     * CSSä¸Šã®è¡¨ç¤ºã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦ã€Canvasã®å†…éƒ¨è§£åƒåº¦ï¼ˆdprï¼‰ã‚’èª¿æ•´ã™ã‚‹
     */
    resizeCanvasToDisplaySize() {
      const dpr = window.devicePixelRatio || 1;
      const rect = cv.getBoundingClientRect();
      const w = Math.max(1, Math.floor(rect.width * dpr));
      const h = Math.max(1, Math.floor(rect.height * dpr));

      if (cv.width !== w || cv.height !== h) {
        cv.width = w;
        cv.height = h;
      }

      // CSS px â†’ device px ã¸æ›ç®—ã—ãŸ â€œä¸­å¿ƒã‚ªãƒ•ã‚»ãƒƒãƒˆâ€
      this.centerYOffsetPx = Math.round(DEFAULT_CENTER_Y_OFFSET_CSS * dpr);

      // transform ã‚’åˆæœŸåŒ–ï¼ˆæç”»ã®ç©ã¿é‡ãªã‚Šã‚’é˜²ãï¼‰
      ctx.setTransform(1, 0, 0, 1, 0, 0);
    }

    // --------------------------
    // Row defaults / utilities
    // --------------------------

    /** å…¥åŠ›æ¬„è¿½åŠ æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ*/
    newRowDefaults() {
      const idx = this.rows.length;
      const base = palette[idx % palette.length];

      return new RowModel({
        id: this.nextId++,
        N: null,
        M: null,

        start: DEFAULT_START,
        animTimeSec: DEFAULT_ANIM_TIME,

        visible: true,
        showPoints: true,
        showLabels: false,

        labelSizePx: DEFAULT_LABEL_SIZE,

        lineColor: base,
        pointColor: base,

        animPlaying: false,
        animProgressEdges: 0.0,
        animSpeedEdgesPerSec: 0.0,
      });
    }

    /** UIè¡¨ç¤ºç”¨ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆã‚«ãƒ¼ãƒ‰ã®è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ãªã©ã§ä½¿ç”¨ï¼‰ */
    rowTitle(r) {
      const n = (r.N == null ? "" : r.N);
      const m = (r.M == null ? "" : r.M);
      return `#${r.id}  N=${n}, M=${m}`;
    }

    /**
     * å…¥åŠ›æ¬„ã® â€œå·¡å›æƒ…å ±â€ ã‚’è¨ˆç®—ã—ã¦ã¾ã¨ã‚ã¦è¿”ã™
     * - valid=false ã®ã¨ãã¯æç”»ã—ãªã„
     */
    getCycleInfo(r) {
      const N = r.N, M = r.M;

      // å…¥åŠ›ãƒã‚§ãƒƒã‚¯ï¼šæ•´æ•°ã§ã€N>=3, M>=1 ã§ã‚ã‚‹ã“ã¨
      if (!Number.isInteger(N) || !Number.isInteger(M) || N < 3 || M < 1) {
        return { edges: 0, step: 0, L: 0, d: 0, startN: 0, cycle: [0], valid: false };
      }

      // M mod N
      const step = normalizeStep(N, M);

      // start ã‚’ N ã§æ­£è¦åŒ–
      const startN = normalizeStart(N, r.start);

      // M = 0 ã®å ´åˆã¯å‹•ã‹ãªã„ï¼ˆé ‚ç‚¹1ã¤ï¼‰
      if (step === 0) {
        return { edges: 0, step, L: 0, d: gcd(N, step), startN, cycle: [startN], valid: true };
      }

      // å·¡å›åˆ—ï¼ˆå§‹ç‚¹ã«æˆ»ã‚‹ã¾ã§ï¼‰
      const cycle = buildCycle(N, step, startN);

      // è¾ºã®æœ¬æ•°ï¼ˆç‚¹åˆ—ã®é•·ã• - 1ï¼‰
      const edges = Math.max(0, cycle.length - 1);

      // gcdï¼ˆé–‰è·¯ã®æœ¬æ•°ãªã©ã®ç†è§£ã«å½¹ç«‹ã¤æŒ‡æ¨™ï¼‰
      const d = gcd(N, step);

      // é–‰è·¯é•· Lï¼ˆã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ edges ã¨åŒã˜ï¼‰
      const L = edges;

      return { edges, step, L, d, startN, cycle, valid: true };
    }

    /**
     * å…¨ã‚¢ãƒ‹ãƒ¡å†ç”Ÿã®ãŸã‚ã® â€œé€Ÿåº¦ï¼ˆedges/secï¼‰â€ ã‚’æƒãˆã‚‹
     * - ä¸€ç•ªé•·ã„æ™‚é–“ã«åˆã‚ã›ã¦ã€å…¨è¡ŒãŒåŒã˜â€œçµ‚äº†ã‚¿ã‚¤ãƒŸãƒ³ã‚°â€ã«ãªã‚‹ã‚ˆã†ã«ã™ã‚‹
     */
    prepareSpeedsForAll() {
      const validRows = this.rows.filter(r => this.getCycleInfo(r).valid && this.getCycleInfo(r).edges > 0);
      const times = validRows.map(r => Math.max(0.2, Number(r.animTimeSec) || DEFAULT_ANIM_TIME));
      const Tglobal = times.length ? Math.max(...times) : DEFAULT_ANIM_TIME;

      for (const r of this.rows) {
        const info = this.getCycleInfo(r);
        const edges = info.edges;

        r.animProgressEdges = 0.0;
        r.animSpeedEdgesPerSec = (info.valid && edges > 0) ? (edges / Tglobal) : 0.0;
      }
    }

    /**
     * n
     å…¥åŠ›æ¬„ï¼ˆN/Må…¥åŠ›ãƒ»å†ç”Ÿãƒ»è¨­å®šãƒ»å‰Šé™¤ï¼‰ã‚’ç”Ÿæˆ
     * - DOMæ§‹é€ ã€ã‚¤ãƒ™ãƒ³ãƒˆã€å†…éƒ¨ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆ_updateMeta/_setAnimIconï¼‰ã‚‚ä»˜ä¸
     */
    createRowUI(r) {
      const app = this; // this ãŒå¤‰ã‚ã‚‹ã®ã§é€€é¿ã—ã¦ãŠã

      const card = document.createElement('div');
      card.className = 'rowCard';
      card.dataset.rowId = String(r.id);

      // --- N input ---
      const fieldN = document.createElement('div');
      fieldN.className = 'field';
      fieldN.innerHTML = `<div class="label">N</div>`;
      const inN = document.createElement('input');
      inN.type = 'number';
      inN.min = '1';
      inN.step = '1';
      inN.placeholder = 'ï¼ˆæœªå…¥åŠ›ï¼‰';
      inN.value = (r.N == null ? '' : String(r.N));
      fieldN.appendChild(inN);

      // --- M input ---
      const fieldM = document.createElement('div');
      fieldM.className = 'field';
      fieldM.innerHTML = `<div class="label">M</div>`;
      const inM = document.createElement('input');
      inM.type = 'number';
      inM.min = '1';
      inM.step = '1';
      inM.placeholder = 'ï¼ˆæœªå…¥åŠ›ï¼‰';
      inM.value = (r.M == null ? '' : String(r.M));
      fieldM.appendChild(inM);

      // --- Buttons ---
      const btnAnim = document.createElement('button');
      btnAnim.className = 'iconBtn';
      btnAnim.title = 'ã“ã®è¡Œã®ã‚¢ãƒ‹ãƒ¡ å†ç”Ÿ/åœæ­¢';
      btnAnim.textContent = 'â–¶';

      const btnGear = document.createElement('button');
      btnGear.className = 'iconBtn';
      btnGear.title = 'è¨­å®š';
      btnGear.textContent = 'âš™';

      const btnDel = document.createElement('button');
      btnDel.className = 'iconBtn';
      btnDel.title = 'å‰Šé™¤';
      btnDel.textContent = 'ğŸ—‘';

      // --- Meta info ---
      const meta = document.createElement('div');
      meta.className = 'rowMeta';

      /** start/step/gcd/é–‰è·¯é•·/æ™‚é–“/è‰²ã®æƒ…å ±ã‚’å…¥åŠ›æ¬„ã®ä¸‹ã«è¡¨ç¤º */
      function updateMeta() {
        const N = r.N, M = r.M;
        if (!Number.isInteger(N) || !Number.isInteger(M)) {
          meta.textContent = `æœªå…¥åŠ›ï¼ˆN,Mã‚’å…¥ã‚Œã‚‹ã¨æç”»ã—ã¾ã™ï¼‰`;
          return;
        }
        if (N < 3) {
          meta.textContent = `æ³¨æ„: N=${N} ã¯å¤šè§’å½¢ã«ãªã‚Šã¾ã›ã‚“ï¼ˆNâ‰¥3æ¨å¥¨ï¼‰`;
          return;
        }
        if (M < 1) {
          meta.textContent = `æ³¨æ„: M ã¯ 1 ä»¥ä¸Š`;
          return;
        }
        const info = app.getCycleInfo(r);
        const sw = `<span class="swatch" style="background:${r.lineColor}"></span>`;
        meta.innerHTML =
          `start=${info.startN}, step=M mod N=${info.step}, gcd(N,M)=${info.d}, é–‰è·¯é•·L=${info.L}, time=${r.animTimeSec.toFixed(1)}s ${sw}`;
      }

      /** â€œå…¨ã‚¢ãƒ‹ãƒ¡å†ç”Ÿä¸­â€ ã ã£ãŸã‚‰ã€å€‹åˆ¥æ“ä½œã‚’å„ªå…ˆã—ã¦åœæ­¢ã™ã‚‹ */
      function stopGlobalIfNeeded() {
        if (app.globalPlaying) {
          app.globalPlaying = false;
          btnToggleAll.textContent = "â–¶ å…¨ã‚¢ãƒ‹ãƒ¡å†ç”Ÿ";
        }
      }

      /** å€‹åˆ¥ã‚¢ãƒ‹ãƒ¡çŠ¶æ…‹ã‚’åˆæœŸåŒ–ï¼ˆN/Må¤‰æ›´ãªã©ã®ãŸã³ã«å‘¼ã³ã ã™ï¼‰ */
      function resetAnim() {
        r.animPlaying = false;
        r.animProgressEdges = 0.0;
        card._setAnimIcon();
      }

      /** Nå…¥åŠ›ã‚’åæ˜ ï¼ˆç©ºãªã‚‰nullï¼‰ */
      function applyN() {
        const raw = inN.value.trim();
        if (raw === '') {
          r.N = null;
          resetAnim();
          stopGlobalIfNeeded();
          card._updateMeta();
          app.scheduleDraw();
          return;
        }
        const v = Math.floor(Number(raw));
        r.N = Number.isFinite(v) ? v : null;
        if (r.N != null && r.N < 1) r.N = 1;
        inN.value = (r.N == null ? '' : String(r.N));

        resetAnim();
        stopGlobalIfNeeded();
        card._updateMeta();
        app.scheduleDraw();
      }

      /** Må…¥åŠ›ã‚’åæ˜ ï¼ˆç©ºãªã‚‰nullï¼‰ */
      function applyM() {
        const raw = inM.value.trim();
        if (raw === '') {
          r.M = null;
          resetAnim();
          stopGlobalIfNeeded();
          card._updateMeta();
          app.scheduleDraw();
          return;
        }
        const v = Math.floor(Number(raw));
        r.M = Number.isFinite(v) ? v : null;
        if (r.M != null && r.M < 1) r.M = 1;
        inM.value = (r.M == null ? '' : String(r.M));

        resetAnim();
        stopGlobalIfNeeded();
        card._updateMeta();
        app.scheduleDraw();
      }

      // å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
      inN.addEventListener('input', applyN);
      inM.addEventListener('input', applyM);
      inN.addEventListener('change', applyN);
      inM.addEventListener('change', applyM);

      // å†ç”Ÿ/åœæ­¢ãƒœã‚¿ãƒ³
      btnAnim.addEventListener('click', () => {
        const info = app.getCycleInfo(r);
        const edges = info.edges;

        // ç„¡åŠ¹ãªã‚‰ä½•ã‚‚ã›ãšåˆæœŸåŒ–
        if (!info.valid || edges <= 0) {
          r.animPlaying = false;
          r.animProgressEdges = 0.0;
          card._setAnimIcon();
          return;
        }

        // å…¥åŠ›æ¬„ã”ã¨ã®ã‚¢ãƒ‹ãƒ¡æ™‚é–“ã«åˆã‚ã›ã¦é€Ÿåº¦ã‚’æ±ºã‚ã‚‹
        const T = Math.max(0.2, Number(r.animTimeSec) || DEFAULT_ANIM_TIME);
        r.animSpeedEdgesPerSec = edges > 0 ? (edges / T) : 0.0;

        // ãƒˆã‚°ãƒ«å†ç”Ÿï¼šå†ç”Ÿé–‹å§‹æ™‚ã¯é€²æ—ã‚’0ã«æˆ»ã™
        r.animPlaying = !r.animPlaying;
        if (r.animPlaying) r.animProgressEdges = 0.0;
        card._setAnimIcon();

        stopGlobalIfNeeded();
        app.scheduleDraw();
      });

      // è¨­å®š
      btnGear.addEventListener('click', () => app.openRowSettings(r, card));

      // å‰Šé™¤
      btnDel.addEventListener('click', () => {
        const i = app.rows.findIndex(x => x.id === r.id);
        if (i >= 0) app.rows.splice(i, 1);
        card.remove();

        if (app.selectedRowId === r.id) app.selectedRowId = null;

        if (app.globalPlaying) {
          app.globalPlaying = false;
          btnToggleAll.textContent = "â–¶ å…¨ã‚¢ãƒ‹ãƒ¡å†ç”Ÿ";
        }

        app.scheduleDraw();
      });

      // â€œå…¥åŠ›æ¬„ã®ã‚«ãƒ¼ãƒ‰å†…éƒ¨ãƒ¡ã‚½ãƒƒãƒ‰â€ ã‚’ä»˜ä¸ï¼ˆå…ƒã‚³ãƒ¼ãƒ‰äº’æ›ï¼‰
      card._updateMeta = updateMeta;
      card._setAnimIcon = () => { btnAnim.textContent = r.animPlaying ? 'â¸' : 'â–¶'; };

      // DOMçµ„ã¿ç«‹ã¦
      card.appendChild(fieldN);
      card.appendChild(fieldM);
      card.appendChild(btnAnim);
      card.appendChild(btnGear);
      card.appendChild(btnDel);
      card.appendChild(meta);

      // åˆæœŸè¡¨ç¤º
      updateMeta();
      card._setAnimIcon();

      return card;
    }

    /** å…¥åŠ›æ¬„ã‚’è¿½åŠ ã—ã¦ã€UIã«ã‚‚åæ˜  */
    addRow(initial) {
      const r = Object.assign(this.newRowDefaults(), initial || {});

      // ãƒ‘ãƒ¬ãƒƒãƒˆè‰²ã¯ â€œè¿½åŠ é †â€ ã§æ±ºã‚ã‚‹
      const idx = this.rows.length;
      const base = palette[idx % palette.length];
      if (!initial || !initial.lineColor) r.lineColor = base;
      if (!initial || !initial.pointColor) r.pointColor = base;

      // ã‚¢ãƒ‹ãƒ¡æ™‚é–“ãƒ»ãƒ©ãƒ™ãƒ«ã‚µã‚¤ã‚ºã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      const t = Number(r.animTimeSec);
      r.animTimeSec = (Number.isFinite(t) && t >= 0.2) ? t : DEFAULT_ANIM_TIME;

      const ls = Math.floor(Number(r.labelSizePx));
      r.labelSizePx = (Number.isFinite(ls) && ls >= 8) ? ls : DEFAULT_LABEL_SIZE;

      // è¿½åŠ 
      this.rows.push(r);
      rowsEl.appendChild(this.createRowUI(r));

      // è¿½åŠ ã—ãŸã‚‰å…¨ä½“å†ç”Ÿä¸­ã¯åœæ­¢
      if (this.globalPlaying) {
        this.globalPlaying = false;
        btnToggleAll.textContent = "â–¶ å…¨ã‚¢ãƒ‹ãƒ¡å†ç”Ÿ";
      }

      this.scheduleDraw();
    }

    // --------------------------
    // Row settings modal
    // --------------------------

    /** å…¥åŠ›æ¬„ã®è¨­å®šã‚’é–‹ãï¼ˆãƒã‚§ãƒƒã‚¯ãƒ»è‰²ãƒ»æ™‚é–“ãªã©ã‚’ç·¨é›†ï¼‰ */
    openRowSettings(r, card) {
      this.modalRow = r;
      this.modalRowCard = card;

      rowModalTitle.textContent = `è¨­å®š ${this.rowTitle(r)}`;

      optVisible.checked = r.visible;
      optShowPoints.checked = r.showPoints;
      optShowLabels.checked = r.showLabels;

      optLabelSize.value = String(r.labelSizePx);

      optLineColor.value = r.lineColor;
      optPointColor.value = r.pointColor;

      optAnimTime.value = String(Number(r.animTimeSec).toFixed(1));
      optStart.value = String(Number.isFinite(r.start) ? r.start : 0);

      rowModalOverlay.style.display = 'flex';
    }

    /** å…¥åŠ›æ¬„ã®è¨­å®šã‚’é–‰ã˜ã‚‹ */
    closeRowSettings() {
      rowModalOverlay.style.display = 'none';
      this.modalRow = null;
      this.modalRowCard = null;
    }

    /**
     * å…¥åŠ›å€¤ã‚’ Row ã«åæ˜ 
     * - åæ˜ ã—ãŸã‚‰è¨­å®šãŒå¤‰ã‚ã‚‹ã®ã§ã‚¢ãƒ‹ãƒ¡ã¯æ­¢ã‚ã‚‹
     */
    syncRowModalToRow() {
      if (!this.modalRow) return;
      const r = this.modalRow;

      r.visible = optVisible.checked;
      r.showPoints = optShowPoints.checked;
      r.showLabels = optShowLabels.checked;

      // ãƒ©ãƒ™ãƒ«ã‚µã‚¤ã‚ºï¼ˆ8ä»¥ä¸Šï¼‰
      {
        const v = Math.floor(Number(optLabelSize.value));
        r.labelSizePx = (Number.isFinite(v) && v >= 8) ? v : DEFAULT_LABEL_SIZE;
        optLabelSize.value = String(r.labelSizePx);
      }

      // è‰²
      r.lineColor = optLineColor.value;
      r.pointColor = optPointColor.value;

      // ã‚¢ãƒ‹ãƒ¡æ™‚é–“ï¼ˆ0.2ä»¥ä¸Šï¼‰
      {
        const v = Number(optAnimTime.value);
        r.animTimeSec = (Number.isFinite(v) && v >= 0.2) ? v : DEFAULT_ANIM_TIME;
        optAnimTime.value = String(r.animTimeSec.toFixed(1));
      }

      // startï¼ˆæ•´æ•°ï¼‰
      {
        const v = Math.floor(Number(optStart.value));
        r.start = Number.isFinite(v) ? v : 0;
        optStart.value = String(r.start);
      }

      // è¨­å®šå¤‰æ›´æ™‚ã¯ã‚¢ãƒ‹ãƒ¡åœæ­¢
      r.animPlaying = false;
      r.animProgressEdges = 0.0;

      // å…¨ä½“å†ç”Ÿã‚‚æ­¢ã‚ã‚‹
      if (this.globalPlaying) {
        this.globalPlaying = false;
        btnToggleAll.textContent = "â–¶ å…¨ã‚¢ãƒ‹ãƒ¡å†ç”Ÿ";
      }

      // å…¥åŠ›æ¬„ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºæ›´æ–°
      if (this.modalRowCard && this.modalRowCard._updateMeta) this.modalRowCard._updateMeta();
      if (this.modalRowCard && this.modalRowCard._setAnimIcon) this.modalRowCard._setAnimIcon();

      this.scheduleDraw();
    }

    // --------------------------
    // Global settings modal
    // --------------------------

    /** å…¨ä½“è¨­å®šã‚’é–‹ã */
    openGlobalSettings() {
      optCircleColor.value = themeManager.state.circleHex;
      optTheme.value = themeManager.state.theme;
      globalModalOverlay.style.display = 'flex';
    }

    /** å…¨ä½“è¨­å®šã‚’é–‰ã˜ã‚‹ */
    closeGlobalSettings() {
      globalModalOverlay.style.display = 'none';
    }

    /** èƒŒæ™¯ã‚’å¡—ã‚Šã¤ã¶ã—ã¦ï¼Œè¨­å®šã‚ˆã‚Šè‰²ã‚’å¤‰ãˆã‚‹ */
    clearAndFillCanvas() {
      const fill = (themeManager.state.theme === 'dark') ? '#0b0f17' : '#ffffff';
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.fillStyle = fill;
      ctx.fillRect(0, 0, cv.width, cv.height);
    }

    /** å¤–æ¥å††ï¼ˆ1æœ¬ã ã‘ï¼‰ã‚’æã */
    drawCircle(cx, cy, r) {
      ctx.save();
      ctx.beginPath();
      ctx.arc(cx, cy, r, 0, TAU);

      // CSSå¤‰æ•° --circle ã‚’å‚ç…§ï¼ˆè¨­å®šã§å¤‰ã‚ã‚‹ï¼‰
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--circle').trim();
      ctx.lineWidth = Math.max(1, cv.width * 0.002);
      ctx.stroke();
      ctx.restore();
    }

    /** ãƒ©ãƒ™ãƒ«æ–‡å­—è‰²ã‚’èƒŒæ™¯ã«åŒåŒ–ã—ãªã„ã‚ˆã†ã«è¨­å®š */
    getLabelColor() {
      return (themeManager.state.theme === 'light')
        ? 'rgba(17,24,39,0.95)'
        : 'rgba(255,255,255,0.92)';
    }

    /** ãƒ©ãƒ™ãƒ«ã®ç¸å–ã‚Šè‰²ã‚’èƒŒæ™¯ã«åŒåŒ–ã—ãªã„ã‚ˆã†ã«è¨­å®š*/
    getLabelStrokeColor() {
      return (themeManager.state.theme === 'light')
        ? 'rgba(255,255,255,0.92)'
        : 'rgba(0,0,0,0.78)';
    }

    /**
     * å…¥åŠ›æ¬„1è¡Œåˆ†ã®å›³å½¢ã‚’æã
     * - visible/valid ã‚’æº€ãŸã•ãªã„ã¨æã‹ãªã„
     * - ç‚¹ï¼ãƒ©ãƒ™ãƒ«ï¼ç·šï¼ˆã‚¢ãƒ‹ãƒ¡é€²æ—ï¼‰ã‚’é †ã«æç”»
     */
    drawRow(r, cx, cy, radius) {
      if (!r.visible) return;

      const info = this.getCycleInfo(r);
      if (!info.valid) return;

      const N = r.N;
      const pts = pointsOnCircle(N, cx, cy, radius);

      // ---- é ‚ç‚¹ï¼ˆç‚¹ï¼‰ã‚’æã ----
      if (r.showPoints && N >= 1) {
        ctx.save();
        const dot = Math.max(2, cv.width * 0.004) / view.scale;
        for (let i = 0; i < N; i++) {
          ctx.beginPath();
          ctx.arc(pts[i].x, pts[i].y, dot, 0, TAU);
          ctx.fillStyle = r.pointColor;
          ctx.globalAlpha = 0.80;
          ctx.fill();
          ctx.globalAlpha = 1.0;
        }
        ctx.restore();
      }

      // ---- é ‚ç‚¹ç•ªå·ï¼ˆãƒ©ãƒ™ãƒ«ï¼‰ã‚’æã ----
      if (r.showLabels && N >= 1) {
        ctx.save();

        const labelColor = this.getLabelColor();
        const strokeColor = this.getLabelStrokeColor();

        // view.scale ã«ã‚ˆã£ã¦æ‹¡å¤§ç¸®å°æ™‚ã‚‚ â€œè¦‹ã‚„ã™ã„ã‚µã‚¤ã‚ºâ€ ã«è¦‹ãˆã‚‹ã‚ˆã†èª¿æ•´
        const size = Math.max(8, (Number(r.labelSizePx) || DEFAULT_LABEL_SIZE)) / view.scale;

        // KaTeXãƒ•ã‚©ãƒ³ãƒˆ
        ctx.font = `700 ${size}px "KaTeX_Main","KaTeX_Math","Times New Roman",serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        // ãƒ©ãƒ™ãƒ«ã‚’ç‚¹ã‹ã‚‰å°‘ã—å¤–å´ã«è¡¨ç¤º
        const off = Math.max(14, (cv.width * 0.022)) / view.scale;

        for (let i = 0; i < N; i++) {
          const vx = pts[i].x - cx, vy = pts[i].y - cy;
          const len = Math.hypot(vx, vy) || 1;
          const tx = pts[i].x + (vx / len) * off;
          const ty = pts[i].y + (vy / len) * off;

          // èƒŒæ™¯ã¨è¢«ã£ã¦ã‚‚èª­ã‚ã‚‹ã‚ˆã†ã«ç¸å–ã‚Š
          ctx.lineWidth = Math.max(2.5, size * 0.22);
          ctx.strokeStyle = strokeColor;
          ctx.strokeText(String(i), tx, ty);

          // æœ¬ä½“
          ctx.fillStyle = labelColor;
          ctx.fillText(String(i), tx, ty);
        }

        ctx.restore();
      }

      // ---- è¾ºï¼ˆç·šï¼‰ã‚’æãï¼šã‚¢ãƒ‹ãƒ¡é€²æ—ã«å¿œã˜ã¦éƒ¨åˆ†æç”» ----
      const totalEdges = info.edges;
      if (totalEdges <= 0) return;

      // animPlaying ã®ã¨ãã¯ â€œé€”ä¸­ã¾ã§â€ï¼Œãã†ã§ãªã‘ã‚Œã° â€œå…¨éƒ¨â€
      const p = r.animPlaying
        ? Math.max(0, Math.min(totalEdges, r.animProgressEdges))
        : totalEdges;

      const whole = Math.floor(p);
      const frac = p - whole;

      if (whole <= 0 && frac <= 0) return;

      const cycle = info.cycle;

      ctx.save();
      ctx.beginPath();
      ctx.moveTo(pts[cycle[0]].x, pts[cycle[0]].y);

      // è¾ºã‚’wholeæœ¬ã‚’æã
      for (let i = 1; i <= whole; i++) {
        ctx.lineTo(pts[cycle[i]].x, pts[cycle[i]].y);
      }

      // æ¬¡ã®è¾ºã‚’ â€œfracâ€ ã ã‘ï¼ˆé€”ä¸­ã¾ã§ï¼‰æã
      if (whole < totalEdges && frac > 0) {
        const aIdx = cycle[whole];
        const bIdx = cycle[whole + 1];
        const ax = pts[aIdx].x, ay = pts[aIdx].y;
        const bx = pts[bIdx].x, by = pts[bIdx].y;
        const mx = ax + (bx - ax) * frac;
        const my = ay + (by - ay) * frac;
        ctx.lineTo(mx, my);
      }

      // ç·šã‚¹ã‚¿ã‚¤ãƒ«
      ctx.strokeStyle = r.lineColor;
      ctx.globalAlpha = 0.95;
      ctx.lineWidth = Math.max(1.5, cv.width * 0.0045) / view.scale;
      ctx.lineJoin = 'round';
      ctx.lineCap = 'round';
      ctx.stroke();
      ctx.globalAlpha = 1.0;

      // é¸æŠä¸­ã®å›³å½¢ã¯å¤ªãè–„ããƒã‚¤ãƒ©ã‚¤ãƒˆ
      if (this.selectedRowId === r.id) {
        ctx.globalAlpha = 0.18;
        ctx.lineWidth = (Math.max(8, cv.width * 0.012) / view.scale);
        ctx.strokeStyle = r.lineColor;
        ctx.stroke();
        ctx.globalAlpha = 1.0;
      }

      ctx.restore();
    }

    /** è§’ä¸¸çŸ©å½¢ãƒ‘ã‚¹ï¼ˆHUDèƒŒæ™¯ãªã©ã§åˆ©ç”¨ï¼‰ */
    roundRect(ctxLocal, x, y, w, h, r) {
      const rr = Math.min(r, w / 2, h / 2);
      ctxLocal.beginPath();
      ctxLocal.moveTo(x + rr, y);
      ctxLocal.arcTo(x + w, y, x + w, y + h, rr);
      ctxLocal.arcTo(x + w, y + h, x, y + h, rr);
      ctxLocal.arcTo(x, y + h, x, y, rr);
      ctxLocal.arcTo(x, y, x + w, y, rr);
      ctxLocal.closePath();
    }

    /** é¸æŠä¸­ã®è¡Œã® N/M ã‚’å·¦ä¸Šã« HUD è¡¨ç¤ºã™ã‚‹ */
    drawHUD() {
      if (this.selectedRowId == null) return;

      const r = this.rows.find(x => x.id === this.selectedRowId);
      if (!r) return;

      const info = this.getCycleInfo(r);
      if (!info.valid) return;

      const bg = getComputedStyle(document.documentElement).getPropertyValue('--hudBg').trim();
      const fg = getComputedStyle(document.documentElement).getPropertyValue('--hudFg').trim();
      const bd = getComputedStyle(document.documentElement).getPropertyValue('--hudBorder').trim();

      const x = 12, y = 12;

      const fontSize = Math.min(110, Math.max(34, cv.width * 0.060));
      const pad = Math.round(fontSize * 0.35);

      const texFont = `"KaTeX_Main","KaTeX_Math","Times New Roman",serif`;
      const line1 = `N=${r.N},  M=${r.M}`;

      ctx.save();
      ctx.setTransform(1, 0, 0, 1, 0, 0);

      // ç®±ã‚µã‚¤ã‚ºã‚’æ–‡å­—å¹…ã‹ã‚‰æ±ºã‚ã‚‹
      ctx.font = `700 ${fontSize}px ${texFont}`;
      const w1 = ctx.measureText(line1).width;

      const boxW = w1 + pad * 2 + 10;
      const boxH = pad * 2 + fontSize + Math.round(fontSize * 0.25);

      this.roundRect(ctx, x, y, boxW, boxH, 14);
      ctx.fillStyle = bg;
      ctx.fill();
      ctx.lineWidth = 3;
      ctx.strokeStyle = bd;
      ctx.stroke();

      // å·¦ã®è‰²å¸¯ï¼ˆãã®è¡Œã®è‰²ï¼‰
      ctx.fillStyle = r.lineColor;
      ctx.globalAlpha = 0.88;
      this.roundRect(ctx, x + 8, y + 8, Math.max(12, fontSize * 0.16), boxH - 16, 10);
      ctx.fill();
      ctx.globalAlpha = 1.0;

      // æ–‡å­—
      ctx.fillStyle = fg;
      ctx.font = `700 ${fontSize}px ${texFont}`;
      ctx.fillText(line1, x + pad + 18, y + pad + fontSize - 4);

      ctx.restore();
    }

    /** å…¨æç”»ï¼ˆå¤–æ¥å††â†’å„è¡Œâ†’HUDï¼‰ */
    drawAll() {
      this.resizeCanvasToDisplaySize();
      this.clearAndFillCanvas();

      const cx = cv.width / 2;
      const cy = cv.height / 2 + this.centerYOffsetPx;

      // å¤–æ¥å††åŠå¾„ï¼šCanvasã‚µã‚¤ã‚ºã‹ã‚‰æ±ºã‚ã‚‹ï¼ˆå…ƒã‚³ãƒ¼ãƒ‰åŒå€¤ï¼‰
      const baseRadius = Math.min(cv.width, cv.height) * 0.82 * 0.5 * 0.9;

      // viewï¼ˆãƒ‘ãƒ³/ã‚ºãƒ¼ãƒ ï¼‰ã‚’é©ç”¨ã—ãŸåº§æ¨™ç³»ã§æã
      ctx.save();
      ctx.translate(cx + view.panX, cy + view.panY);
      ctx.scale(view.scale, view.scale);

      // åº§æ¨™ç³»ã®åŸç‚¹ (0,0) ã‚’å††ã®ä¸­å¿ƒã¨ã¿ãªã™
      this.drawCircle(0, 0, baseRadius);

      for (const r of this.rows) {
        this.drawRow(r, 0, 0, baseRadius);
      }

      ctx.restore();

      // HUDã¯ç”»é¢å›ºå®šï¼ˆãƒ‘ãƒ³/ã‚ºãƒ¼ãƒ ã®å½±éŸ¿ã‚’å—ã‘ãªã„ï¼‰
      this.drawHUD();
    }

    /** å·¦ãƒ‘ãƒãƒ«ä¸‹ã®çµ±è¨ˆè¡¨ç¤ºï¼ˆè¡¨ç¤ºæ•°ãƒ»ã‚¢ãƒ‹ãƒ¡æ•°ï¼‰ */
    updateGlobalInfo() {
      const total = this.rows.length;
      const playing = this.rows.filter(r => r.animPlaying).length;

      globalInfoEl.innerHTML = `
        <b>è¡¨ç¤ºæ•°</b>: ${total}<br/>
        <b>ã‚¢ãƒ‹ãƒ¡ä¸­</b>: ${playing} / ${total}<br/>
      `;
    }

    /** ã‚¢ãƒ‹ãƒ¡ä¸­ã®ã‚‚ã®ãŒã‚ã‚‹ã‹ã©ã†ã‹ã®ç¢ºèª */
    anyAnimationPlaying() {
      return this.rows.some(r => r.animPlaying);
    }

    /**
     * requestAnimationFrame ã® tick
     * - dtï¼ˆç§’ï¼‰ã‚’è¨ˆç®—ã—ã€å„å…¥åŠ›æ¬„ã® animProgressEdges ã‚’é€²ã‚ã‚‹
     * - çµ‚äº†ã—ãŸå›³å½¢ã¯ animPlaying=false ã«ã™ã‚‹
     */
    tick(t) {
      if (this.lastT == null) this.lastT = t;
      const dt = (t - this.lastT) / 1000;
      this.lastT = t;

      for (const r of this.rows) {
        if (!r.animPlaying) continue;

        const info = this.getCycleInfo(r);
        const edges = info.edges;

        if (!info.valid || edges <= 0) {
          r.animPlaying = false;
          continue;
        }

        r.animProgressEdges += (r.animSpeedEdgesPerSec * dt);

        // çµ‚äº†åˆ¤å®š
        if (r.animProgressEdges >= edges) {
          r.animProgressEdges = edges;
          r.animPlaying = false;

          // UIã‚¢ã‚¤ã‚³ãƒ³ã‚’æ­¢ã‚ã‚‹
          const card = rowsEl.querySelector(`.rowCard[data-row-id="${r.id}"]`);
          if (card && card._setAnimIcon) card._setAnimIcon();
        }
      }

      this.drawAll();
      this.updateGlobalInfo();

      if (this.anyAnimationPlaying()) {
        this.rafId = requestAnimationFrame((tt) => this.tick(tt));
      } else {
        this.rafId = null;
        this.lastT = null;

        // å…¨ä½“å†ç”Ÿä¸­ãƒ•ãƒ©ã‚°ã®å¾Œå‡¦ç†
        if (this.globalPlaying) {
          this.globalPlaying = false;
          btnToggleAll.textContent = "â–¶ å…¨ã‚¢ãƒ‹ãƒ¡å†ç”Ÿ";
        }
      }
    }

    /**
     * â€œæç”»ã‚’è¦æ±‚ã™ã‚‹â€ ãŸã‚ã®é–¢æ•°
     * - ãã®å ´ã§ drawAll/updateGlobalInfo ã‚’è¡Œã†
     * - ã‚¢ãƒ‹ãƒ¡ä¸­ãªã‚‰ raf ã‚’èµ°ã‚‰ã›ã€æ­¢ã¾ã£ã¦ã„ã‚‹ãªã‚‰ raf ã‚’æ­¢ã‚ã‚‹
     */
    scheduleDraw() {
      this.drawAll();
      this.updateGlobalInfo();

      if (this.anyAnimationPlaying() && !this.rafId) {
        this.rafId = requestAnimationFrame((tt) => this.tick(tt));
      }

      if (!this.anyAnimationPlaying() && this.rafId) {
        cancelAnimationFrame(this.rafId);
        this.rafId = null;
        this.lastT = null;
      }
    }

    /** ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆåº§æ¨™ï¼ˆCSS pxï¼‰â†’ Canvaså†…éƒ¨ãƒ”ã‚¯ã‚»ãƒ«ï¼ˆdpråæ˜ ï¼‰ */
    getCanvasPixelPos(evt) {
      const rect = cv.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      const x = (evt.clientX - rect.left) * dpr;
      const y = (evt.clientY - rect.top) * dpr;
      return { x, y };
    }

    /** ç”»é¢åº§æ¨™ï¼ˆCanvas pxï¼‰â†’ worldåº§æ¨™ï¼ˆãƒ‘ãƒ³/ã‚ºãƒ¼ãƒ ã®é€†å¤‰æ›ï¼‰ */
    screenToWorld(px, py) {
      const cx = cv.width / 2;
      const cy = cv.height / 2 + this.centerYOffsetPx;

      const wx = (px - cx - view.panX) / view.scale;
      const wy = (py - cy - view.panY) / view.scale;

      return { x: wx, y: wy };
    }

    /** ç‚¹Pã¨ç·šåˆ†ABã®è·é›¢ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰ */
    distPointToSegment(px, py, ax, ay, bx, by) {
      const vx = bx - ax, vy = by - ay;
      const wx = px - ax, wy = py - ay;

      const vv = vx * vx + vy * vy;
      if (vv === 0) return Math.hypot(px - ax, py - ay);

      let t = (wx * vx + wy * vy) / vv;
      t = Math.max(0, Math.min(1, t));

      const cx = ax + t * vx;
      const cy = ay + t * vy;

      return Math.hypot(px - cx, py - cy);
    }

    /**
     * ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã«æœ€ã‚‚è¿‘ã„ â€œç·šåˆ†ï¼ˆå›³å½¢ï¼‰â€ ã‚’æ¢ã—ã¦è¡ŒIDã‚’è¿”ã™
     * - è¿‘ã•ãŒé–¾å€¤ä»¥å†…ãªã‚‰å½“ãŸã‚Šï¼ˆé¸æŠï¼‰
     */
    rowHitTest(worldX, worldY) {
      const baseRadius = Math.min(cv.width, cv.height) * 0.82 * 0.5 * 0.9;
      const best = { id: null, d: Infinity };

      for (const r of this.rows) {
        if (!r.visible) continue;

        const info = this.getCycleInfo(r);
        if (!info.valid) continue;
        if (info.edges <= 0) continue;

        const N = r.N;
        const cycle = info.cycle;
        const pts = pointsOnCircle(N, 0, 0, baseRadius);

        for (let i = 0; i < cycle.length - 1; i++) {
          const a = pts[cycle[i]];
          const b = pts[cycle[i + 1]];
          const d = this.distPointToSegment(worldX, worldY, a.x, a.y, b.x, b.y);

          if (d < best.d) {
            best.d = d;
            best.id = r.id;
          }
        }
      }

      // ç”»é¢ä¸Š 12px ç›¸å½“ã®è¿‘ã•ã§ â€œå½“ãŸã‚Šâ€ ã¨ã¿ãªã™ï¼ˆã‚ºãƒ¼ãƒ ã§èª¿æ•´ï¼‰
      const thresholdPx = 12;
      const thresholdWorld = thresholdPx / view.scale;

      if (best.id != null && best.d <= thresholdWorld) return best.id;
      return null;
    }

    /** å„ç¨®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™»éŒ²ã—ã¦èµ·å‹•ã™ã‚‹ */
    init() {
      // --- Row modal events ---
      rowModalClose.addEventListener('click', () => this.closeRowSettings());
      rowModalOverlay.addEventListener('click', (e) => {
        if (e.target === rowModalOverlay) this.closeRowSettings();
      });

      // è¨­å®šã®å…¥åŠ›ãŒå¤‰ã‚ã£ãŸã‚‰å…¥åŠ›æ¬„ã«å³åæ˜ 
      [optVisible, optShowPoints, optShowLabels, optLabelSize, optLineColor, optPointColor, optAnimTime, optStart]
        .forEach(el => {
          el.addEventListener('input', () => this.syncRowModalToRow());
          el.addEventListener('change', () => this.syncRowModalToRow());
        });

      globalModalClose.addEventListener('click', () => this.closeGlobalSettings());
      globalModalOverlay.addEventListener('click', (e) => {
        if (e.target === globalModalOverlay) this.closeGlobalSettings();
      });

      // ãƒ†ãƒ¼ãƒé¸æŠ
      optTheme.addEventListener('change', () => {
        themeManager.state.theme = optTheme.value;
        themeManager.applyTheme(() => this.scheduleDraw());
      });

      // å¤–æ¥å††è‰²
      optCircleColor.addEventListener('input', () => {
        themeManager.state.circleHex = optCircleColor.value;
        themeManager.applyTheme(() => this.scheduleDraw());
      });

      // --- Canvas interactions ---
      let isDragging = false;
      let dragMoved = false;
      let lastX = 0, lastY = 0;

      cv.addEventListener('mousedown', (e) => {
        isDragging = true;
        dragMoved = false;
        const p = this.getCanvasPixelPos(e);
        lastX = p.x;
        lastY = p.y;
        cv.classList.add('dragging');
      });

      window.addEventListener('mouseup', () => {
        isDragging = false;
        cv.classList.remove('dragging');
      });

      window.addEventListener('mousemove', (e) => {
        if (!isDragging) return;

        const p = this.getCanvasPixelPos(e);
        const dx = p.x - lastX;
        const dy = p.y - lastY;

        // ã‚¯ãƒªãƒƒã‚¯èª¤åˆ¤å®šé˜²æ­¢ï¼šå°‘ã—ã§ã‚‚å‹•ã„ãŸã‚‰ â€œãƒ‰ãƒ©ãƒƒã‚°ã—ãŸâ€ ã¨æ‰±ã†
        if (Math.hypot(dx, dy) > 2) dragMoved = true;

        view.panX += dx;
        view.panY += dy;

        lastX = p.x;
        lastY = p.y;

        this.scheduleDraw();
      });

      // ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ ï¼šãƒã‚¦ã‚¹ä½ç½®ã‚’ä¸­å¿ƒã«ã‚ºãƒ¼ãƒ ã™ã‚‹
      cv.addEventListener('wheel', (e) => {
        e.preventDefault();

        const { x: mx, y: my } = this.getCanvasPixelPos(e);

        const cx = cv.width / 2;
        const cy = cv.height / 2 + this.centerYOffsetPx;

        const oldScale = view.scale;
        const zoomFactor = Math.exp((-e.deltaY) * 0.0012);

        let newScale = oldScale * zoomFactor;
        newScale = Math.max(view.minScale, Math.min(view.maxScale, newScale));

        // â€œã‚ºãƒ¼ãƒ å‰ã®worldåº§æ¨™â€ã‚’æ±‚ã‚ã€ã‚ºãƒ¼ãƒ å¾Œã‚‚åŒã˜ç‚¹ãŒãƒã‚¦ã‚¹ä¸‹ã«æ¥ã‚‹ã‚ˆã† pan ã‚’èª¿æ•´
        const worldX = (mx - cx - view.panX) / oldScale;
        const worldY = (my - cy - view.panY) / oldScale;

        view.panX = (mx - cx) - newScale * worldX;
        view.panY = (my - cy) - newScale * worldY;
        view.scale = newScale;

        this.scheduleDraw();
      }, { passive: false });

      // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ãƒ“ãƒ¥ãƒ¼ãƒªã‚»ãƒƒãƒˆ
      cv.addEventListener('dblclick', () => {
        resetView();
        this.scheduleDraw();
      });

      // ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã„ãªã„å ´åˆã®ã¿ï¼‰
      cv.addEventListener('click', (e) => {
        if (dragMoved) return;

        const p = this.getCanvasPixelPos(e);
        const w = this.screenToWorld(p.x, p.y);

        this.selectedRowId = this.rowHitTest(w.x, w.y);
        this.scheduleDraw();
      });

      // --- Controls ---
      btnAdd.addEventListener('click', () => this.addRow());

      // å…¨ã‚¢ãƒ‹ãƒ¡å†ç”Ÿ/åœæ­¢
      btnToggleAll.addEventListener('click', () => {
        this.globalPlaying = !this.globalPlaying;

        if (this.globalPlaying) {
          this.prepareSpeedsForAll();

          for (const r of this.rows) {
            const info = this.getCycleInfo(r);
            r.animPlaying = info.valid && info.edges > 0;
            r.animProgressEdges = 0.0;

            const card = rowsEl.querySelector(`.rowCard[data-row-id="${r.id}"]`);
            if (card && card._setAnimIcon) card._setAnimIcon();
          }

          btnToggleAll.textContent = "â¸ å…¨ã‚¢ãƒ‹ãƒ¡åœæ­¢";
          this.scheduleDraw();
        } else {
          for (const r of this.rows) {
            r.animPlaying = false;
            const card = rowsEl.querySelector(`.rowCard[data-row-id="${r.id}"]`);
            if (card && card._setAnimIcon) card._setAnimIcon();
          }

          btnToggleAll.textContent = "â–¶ å…¨ã‚¢ãƒ‹ãƒ¡å†ç”Ÿ";
          this.scheduleDraw();
        }
      });

      // PNGä¿å­˜
      btnSave.addEventListener('click', () => {
        const url = cv.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = url;
        a.download = `NM-polygons.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      });

      // ãƒªã‚»ãƒƒãƒˆ
      btnReset.addEventListener('click', () => {
        this.globalPlaying = false;
        btnToggleAll.textContent = "â–¶ å…¨ã‚¢ãƒ‹ãƒ¡å†ç”Ÿ";

        if (this.rafId) {
          cancelAnimationFrame(this.rafId);
          this.rafId = null;
          this.lastT = null;
        }

        this.rows.splice(0, this.rows.length);
        rowsEl.innerHTML = '';
        this.selectedRowId = null;
        this.nextId = 1;

        resetView();

        themeManager.applyTheme(() => this.scheduleDraw());

        this.addRow({ N: null, M: null, start: DEFAULT_START, animTimeSec: DEFAULT_ANIM_TIME });
        this.scheduleDraw();
      });

      // å…¨ä½“è¨­å®šã‚’é–‹ã
      btnOpenGlobal.addEventListener('click', () => this.openGlobalSettings());

      // å†æç”»
      window.addEventListener('resize', () => this.scheduleDraw());
    }
  }

  // =========================================================
  // 8) èµ·å‹•
  // =========================================================
  const app = new NMPolygonApp();

  // â€œã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã£ã½ã„â€ æ—¢å­˜åã‚’ä¿æŒ
  // - ãŸã ã—å†…éƒ¨ã¯ app ã«å§”è­²ã™ã‚‹
  function scheduleDraw() { app.scheduleDraw(); }
  function drawAll() { app.drawAll(); }

  // Row modalï¼šå¤–å´ãŒ app ã‚’å‚ç…§ã§ãã‚‹ã‚ˆã†ã« â€œé–¢æ•°åâ€ ã‚’æ®‹ã™ï¼ˆå…ƒã‚³ãƒ¼ãƒ‰äº’æ›ï¼‰
  function openRowSettings(r, card) { app.openRowSettings(r, card); }
  function closeRowSettings() { app.closeRowSettings(); }
  function syncRowModalToRow() { app.syncRowModalToRow(); }

  // Global modalï¼šåŒæ§˜
  function openGlobalSettings() { app.openGlobalSettings(); }
  function closeGlobalSettings() { app.closeGlobalSettings(); }

  // Themeï¼šåŒæ§˜ï¼ˆå†…éƒ¨ã¯ ThemeManagerï¼‰
  function applyTheme() { themeManager.applyTheme(() => app.scheduleDraw()); }

  // initï¼ˆã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ï¼‰
  app.init();

  // åˆæœŸãƒ†ãƒ¼ãƒåæ˜ 
  applyTheme();

  // åˆæœŸå…¥åŠ›æ¬„
  app.addRow({ N: null, M: null, start: DEFAULT_START, animTimeSec: DEFAULT_ANIM_TIME });

})();
</script>
</body>
</html>
