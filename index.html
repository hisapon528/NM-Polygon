<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>正 N/M 角形 可視化ツール（完全版）</title>

<style>
:root{
  --bg:#0b0f17;
  --fg:#e5e7eb;
  --panel:#111827;
  --circle:#888;
}
*{box-sizing:border-box;}
html,body{height:100%;margin:0;}
body{
  background:var(--bg);
  color:var(--fg);
  font-family:system-ui,-apple-system,"Segoe UI","Noto Sans JP",sans-serif;
  overflow:hidden;
}
.wrap{
  display:grid;
  grid-template-columns:420px 1fr;
  height:100vh;
}
.panel{
  background:var(--panel);
  padding:14px;
  overflow-y:auto;
}
.controls{
  position:sticky;
  top:0;
  background:linear-gradient(var(--panel),rgba(17,24,39,.85));
  padding-bottom:10px;
  z-index:10;
}
button{
  margin:4px;
  padding:8px 12px;
  border-radius:10px;
  border:1px solid #666;
  background:#222;
  color:inherit;
  cursor:pointer;
}
.rows{margin-top:10px;}
.row{display:flex;gap:6px;align-items:center;margin-bottom:6px;}
input[type=number]{width:70px;}

.canvasWrap{
  display:flex;
  justify-content:center;
  align-items:center;
}
.square{
  width:min(900px,100%);
  aspect-ratio:1/1;
  position:relative;
}
canvas{width:100%;height:100%;display:block;}

.infoBox{
  position:absolute;
  top:10px;
  left:10px;
  background:rgba(0,0,0,.55);
  color:white;
  padding:6px 10px;
  border-radius:8px;
  font-size:13px;
  pointer-events:none;
  display:none;
}
</style>
</head>

<body>
<div class="wrap">
  <div class="panel">
    <div class="controls">
      <button id="add">＋追加</button>
      <button id="reset">リセット</button>
      <button id="globalSetting">設定</button>
      <button id="save">PNG保存</button>
    </div>
    <div class="rows" id="rows"></div>
  </div>

  <div class="canvasWrap">
    <div class="square">
      <canvas id="cv"></canvas>
      <div class="infoBox" id="infoBox"></div>
    </div>
  </div>
</div>

<script>
/* ===== 基本設定 ===== */
const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");
const rowsEl = document.getElementById("rows");
const infoBox = document.getElementById("infoBox");

let rows=[];
let selected=null;

/* ===== ビュー ===== */
const view={scale:1,panX:0,panY:0};
function resize(){
  const dpr=window.devicePixelRatio||1;
  const r=cv.getBoundingClientRect();
  cv.width=r.width*dpr;
  cv.height=r.height*dpr;
  ctx.setTransform(1,0,0,1,0,0);
}
window.addEventListener("resize",()=>{resize();draw();});

/* ===== 図形 ===== */
function addRow(N=7,M=2){
  rows.push({N,M,color:`hsl(${Math.random()*360},70%,60%)`});
  renderRows();
  draw();
}
function renderRows(){
  rowsEl.innerHTML="";
  rows.forEach((r,i)=>{
    const d=document.createElement("div");
    d.className="row";
    d.innerHTML=`N:<input type=number value=${r.N}>
                 M:<input type=number value=${r.M}>`;
    d.querySelectorAll("input")[0].oninput=e=>{r.N=+e.target.value;draw();}
    d.querySelectorAll("input")[1].oninput=e=>{r.M=+e.target.value;draw();}
    rowsEl.appendChild(d);
  });
}

/* ===== 描画 ===== */
function draw(){
  resize();
  ctx.clearRect(0,0,cv.width,cv.height);
  const cx=cv.width/2,cy=cv.height/2;
  const R=Math.min(cv.width,cv.height)*0.4;
  ctx.save();
  ctx.translate(cx+view.panX,cy+view.panY);
  ctx.scale(view.scale,view.scale);

  // 外接円
  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--circle');
  ctx.beginPath();
  ctx.arc(0,0,R,0,Math.PI*2);
  ctx.stroke();

  rows.forEach(r=>{
    ctx.strokeStyle=r.color;
    ctx.beginPath();
    for(let k=0;k<=r.N;k++){
      const i=(k*r.M)%r.N;
      const a=-Math.PI/2+2*Math.PI*i/r.N;
      const x=R*Math.cos(a),y=R*Math.sin(a);
      if(k===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);
    }
    ctx.stroke();
  });
  ctx.restore();

  if(selected){
    infoBox.style.display="block";
    infoBox.textContent=`N=${selected.N}, M=${selected.M}`;
    infoBox.style.border=`2px solid ${selected.color}`;
  }else{
    infoBox.style.display="none";
  }
}

/* ===== クリック選択 ===== */
cv.addEventListener("click",()=>{
  selected=rows.length?rows[rows.length-1]:null;
  draw();
});

/* ===== マウス操作 ===== */
let drag=false,lx,ly;
cv.onmousedown=e=>{drag=true;lx=e.clientX;ly=e.clientY;}
window.onmouseup=()=>drag=false;
window.onmousemove=e=>{
  if(!drag)return;
  view.panX+=(e.clientX-lx)*(window.devicePixelRatio||1);
  view.panY+=(e.clientY-ly)*(window.devicePixelRatio||1);
  lx=e.clientX;ly=e.clientY;
  draw();
}
cv.onwheel=e=>{
  e.preventDefault();
  view.scale*=Math.exp(-e.deltaY*0.001);
  draw();
}
cv.ondblclick=()=>{view.scale=1;view.panX=view.panY=0;draw();}

/* ===== 操作 ===== */
document.getElementById("add").onclick=()=>addRow();
document.getElementById("reset").onclick=()=>{
  rows=[];
  selected=null;
  view.scale=1;view.panX=view.panY=0;
  addRow();
};
document.getElementById("save").onclick=()=>{
  const a=document.createElement("a");
  a.href=cv.toDataURL();
  a.download="NM.png";
  a.click();
};
document.getElementById("globalSetting").onclick=()=>{
  const bg=prompt("背景色 (black / white)","black");
  if(bg==="white"){
    document.documentElement.style.setProperty("--bg","#fff");
    document.documentElement.style.setProperty("--fg","#000");
    document.documentElement.style.setProperty("--panel","#eee");
  }else{
    document.documentElement.style.setProperty("--bg","#0b0f17");
    document.documentElement.style.setProperty("--fg","#e5e7eb");
    document.documentElement.style.setProperty("--panel","#111827");
  }
};

/* 初期 */
addRow();
</script>
</body>
</html>
